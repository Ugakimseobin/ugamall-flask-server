{% extends "base.html" %}
{% block content %}
<div class="max-w-6xl mx-auto py-10 px-4 sm:px-6 relative">

  <!-- ë’¤ë¡œê°€ê¸° -->
  <button onclick="history.back()" 
          class="absolute top-2 left-6 text-gray-500 hover:text-indigo-600 text-sm sm:text-base font-medium transition">
    â† {{ _("ë’¤ë¡œê°€ê¸°") }}
  </button>

  <!-- ìƒí’ˆ ìƒì„¸ -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 sm:gap-10 bg-white p-4 sm:p-6 shadow rounded">
        <!-- ìƒí’ˆ ì´ë¯¸ì§€ -->
        <div>
          {% if product.image_data %}
            <img src="{{ url_for('serve_product_image', product_id=product.id) }}"
                 alt="{{ product.name }}" 
                 class="w-full h-64 sm:h-96 object-cover rounded">
          {% else %}
            <div class="w-full h-64 sm:h-96 bg-gray-100 flex items-center justify-center text-gray-400 rounded">
              {{ _("ì´ë¯¸ì§€ ì—†ìŒ") }}
            </div>
          {% endif %}
        </div>

        <!-- ìƒí’ˆ ì •ë³´ -->
        <div id="purchase-box">
          <h1 class="text-2xl sm:text-3xl font-bold mb-3 sm:mb-4">{{ _(product.name) }}</h1>
          <p class="text-xl sm:text-2xl text-indigo-600 font-semibold mb-4 sm:mb-6">{{ _("%(price)sì›", price=product.base_price|int|won) }}</p>
          <p class="text-gray-700 text-sm sm:text-base mb-4 sm:mb-6">{{ _(product.description) }}</p>
          <p class="text-xs sm:text-sm text-gray-500 mb-3 sm:mb-4">{{ _("ì¹´í…Œê³ ë¦¬") }}: {{ _(product.category) }}</p>

          <!-- ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸° -->
          <form id="cart-form-main" method="post" action="/add_to_cart" class="mb-3">
            <input type="hidden" name="product_id" value="{{ product.id }}">
            <input type="hidden" id="cart-quantity-main" name="quantity" value="1">

            {% if option_keys %}
              {% for key in option_keys %}
                <label class="block font-semibold mb-2 text-sm">{{ _(key) }}</label>
                <select name="option_{{ key }}" 
                        class="border rounded w-full p-2 mb-4 option-select text-sm" 
                        data-key="{{ key }}">
                  <option value="">-- {{ _("ì„ íƒí•˜ì„¸ìš”") }} --</option>
                  {% set values = [] %}
                  {% for v in product.variants %}
                    {% if v.options[key] not in values %}
                      <option value="{{ v.options[key] }}">{{ _(v.options[key]) }}</option>
                      {% set _ = values.append(v.options[key]) %}
                    {% endif %}
                  {% endfor %}
                </select>
                <input type="hidden" id="cart-option-main-{{ key }}" name="option_{{ key }}">
              {% endfor %}
            {% endif %}

            <!-- ìˆ˜ëŸ‰ -->
            <div class="flex items-center mb-4 sm:mb-6">
              <label class="mr-3 font-semibold text-sm sm:text-base">{{ _("ìˆ˜ëŸ‰") }}</label>
              <div class="flex items-center">
                <button type="button" onclick="changeQuantity('main', -1)"
                        class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-2 sm:px-3 py-1 sm:py-2 rounded-l">-</button>
                <input id="quantity-main" type="number" value="1" min="1" 
                       class="w-16 sm:w-20 text-center border-t border-b p-1 sm:p-2 text-sm sm:text-base">
                <button type="button" onclick="changeQuantity('main', 1)"
                        class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-2 sm:px-3 py-1 sm:py-2 rounded-r">+</button>
              </div>
            </div>

            <button type="submit" class="w-full sm:w-[200px] bg-indigo-600 text-white py-2 sm:py-3 rounded-lg hover:bg-indigo-700">
              {{ _("ì¥ë°”êµ¬ë‹ˆì— ë‹´ê¸°") }}
            </button>
          </form>

          <a href="/contact">
            <button class="mt-3 w-full sm:w-[100px] bg-indigo-600 text-white py-2 sm:py-3 rounded-lg hover:bg-indigo-700">
              {{ _("ë¬¸ì˜") }}
            </button>
          </a>
        </div>
    </div>

    <!-- ê´€ë ¨ìƒí’ˆ -->
  {% if related_products %}
  <div class="mt-14 sm:mt-16">
    <h2 class="text-xl sm:text-2xl font-bold mb-4 text-gray-800">{{ _("ê´€ë ¨ ë¶„ì•¼ ìƒí’ˆ") }}</h2>
    <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4 sm:gap-6">
      {% for p in related_products %}
      <a href="{{ url_for('product_detail', product_id=p.id) }}"
         class="block bg-white p-3 sm:p-4 shadow rounded hover:shadow-lg transition">
        <img src="{{ url_for('serve_product_image', product_id=p.id) }}"
             alt="{{ p.name }}"
             class="h-36 sm:h-44 w-full object-cover rounded">
        <h3 class="mt-2 font-bold text-sm sm:text-base truncate">{{ _(p.name) }}</h3>
        <p class="text-gray-600 text-xs sm:text-sm mt-1">{{ p.price|won }}{{ _("ì›") }}</p>
      </a>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- âœ… ìƒì„¸/ë¦¬ë·° íƒ­ -->
  <div class="mt-16 bg-white shadow rounded-2xl border border-gray-100">
    <div class="flex border-b text-center">
      <button class="tab-btn flex-1 py-3 sm:py-4 text-gray-600 font-semibold border-b-2 border-transparent hover:text-indigo-600 active-tab"
              data-tab="details">{{ _("ìƒì„¸ë³´ê¸°") }}</button>
      <button class="tab-btn flex-1 py-3 sm:py-4 text-gray-600 font-semibold border-b-2 border-transparent hover:text-indigo-600"
              data-tab="reviews">{{ _("ë¦¬ë·°") }}</button>
    </div>

    <!-- ìƒì„¸ë³´ê¸° -->
    <div id="tab-details" class="tab-content p-6 sm:p-8">

      {% if product.pamphlet_data %}
        <!-- âœ… ìƒì„¸ì •ë³´ ë³¸ë¬¸ (ê¸°ë³¸ 600pxê¹Œì§€ë§Œ ë³´ì´ê²Œ, ë”ë³´ê¸° ë²„íŠ¼ìœ¼ë¡œ í™•ì¥) -->
        <div id="pamphlet-wrapper" class="relative overflow-hidden max-h-[950px] transition-all duration-500">
          <div class="fade-overlay absolute bottom-0 left-0 w-full h-36 pointer-events-none z-10"></div>
          {% if product.pamphlet_mime and 'pdf' in product.pamphlet_mime %}
            <iframe src="{{ url_for('serve_pamphlet', product_id=product.id) }}"
                    class="w-full h-[80vh] rounded-xl border"></iframe>
          {% else %}
            <img src="{{ url_for('serve_pamphlet', product_id=product.id) }}"
                alt="pamphlet" class="w-full rounded-xl shadow-lg mb-8">
          {% endif %}
        </div>

        <!-- ë”ë³´ê¸° ë²„íŠ¼ -->
        <div class="text-center mt-4">
          <button id="toggle-info-btn"
                  class="px-6 py-2 rounded-full bg-green-500 text-white font-semibold hover:bg-green-600 transition">
            {{ _("ìƒì„¸ì •ë³´ ë”ë³´ê¸°") }} â–¼
          </button>
        </div>

        <!-- ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ -->
        <div class="mt-6 text-center">
          <a class="inline-flex items-center px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700"
            href="{{ url_for('serve_pamphlet', product_id=product.id) }}" download>
            {{ _("íŒœí”Œë › ë‹¤ìš´ë¡œë“œ") }}
          </a>
        </div>
      {% else %}
        <p class="text-gray-500">{{ _("ë“±ë¡ëœ íŒœí”Œë ›ì´ ì—†ìŠµë‹ˆë‹¤.") }}</p>
      {% endif %}

      <!-- âœ… ë°°ì†¡ ë° êµí™˜/í™˜ë¶ˆ ì•ˆë‚´ (í¬íŠ¸ì› ìš”êµ¬ì‚¬í•­) -->
      <!-- âœ… ìƒí’ˆ ì •ë³´ ì œê³µ ê³ ì‹œ -->
      <div class="mt-12 border-t pt-6">
        <h3 class="text-xl font-bold mb-4 text-gray-800">{{ _("ìƒí’ˆì •ë³´ ì œê³µ ê³ ì‹œ") }}</h3>
        <table class="w-full text-sm border-t border-b border-gray-200">
          <tbody class="divide-y divide-gray-100">
            <tr>
              <td class="font-semibold bg-gray-50 w-1/3 p-3">{{ _("í’ˆëª… ë° ëª¨ë¸ëª…") }}</td>
              <td class="p-3">{{ _(product.name or "-") }}</td>
            </tr>
            <tr>
              <td class="font-semibold bg-gray-50 p-3">{{ _("ì œì¡°êµ­ ë˜ëŠ” ì›ì‚°ì§€") }}</td>
              <td class="p-3">{{ _("ëŒ€í•œë¯¼êµ­") }}</td>
            </tr>
            <tr>
              <td class="font-semibold bg-gray-50 p-3">{{ _("ì œì¡°ì / ìˆ˜ì…ì") }}</td>
              <td class="p-3">{{ _("ìœ ê°€ë©”ë””ì»¬") }}</td>
            </tr>
            <tr>
              <td class="font-semibold bg-gray-50 p-3">A/S {{ _("ì±…ì„ìì™€ ì „í™”ë²ˆí˜¸") }}</td>
              <td class="p-3">{{ _("ìœ ê°€ë©”ë””ì»¬ ê³ ê°ì„¼í„°") }} / 051-522-3969</td>
            </tr>
            <tr>
              <td class="font-semibold bg-gray-50 p-3">{{ _("í’ˆì§ˆë³´ì¦ê¸°ì¤€") }}</td>
              <td class="p-3">{{ _("ê´€ë ¨ ë²• ë° ì†Œë¹„ìë¶„ìŸí•´ê²° ê¸°ì¤€ì— ë”°ë¦„") }}</td>
            </tr>
            <tr>
              <td class="font-semibold bg-gray-50 p-3">{{ _("ë°°ì†¡ ì•ˆë‚´") }}</td>
              <td class="p-3">
                {{ _("íƒë°°") }} (CJëŒ€í•œí†µìš´)<br>
                {{ _("ê²°ì œ ì™„ë£Œ í›„ í‰ê·  2~4ì¼ ì´ë‚´ ë°°ì†¡(ì£¼ë§ ë° ê³µíœ´ì¼ ì œì™¸)") }}
              </td>
            </tr>
            <tr>
              <td class="font-semibold bg-gray-50 p-3">{{ _("êµí™˜/ë°˜í’ˆ ì•ˆë‚´") }}</td>
              <td class="p-3">
                <ul class="list-disc pl-4 space-y-1">
                  <li>{{ _("ìƒí’ˆ ìˆ˜ë ¹ í›„ 7ì¼ ì´ë‚´ ì‹ ì²­ ê°€ëŠ¥í•©ë‹ˆë‹¤") }}.</li>
                  <li>{{ _("ë‹¨ìˆœ ë³€ì‹¬ì˜ ê²½ìš° ì™•ë³µ ë°°ì†¡ë¹„ ê³ ê° ë¶€ë‹´") }}</li>
                  <li>{{ _("ì œí’ˆ ë¶ˆëŸ‰ ë° ì˜¤ë°°ì†¡ ì‹œ ì „ì•¡ ë¬´ë£Œ êµí™˜/í™˜ë¶ˆ") }}</li>
                  <li>{{ _("ê³ ê° ë¶€ì£¼ì˜ë¡œ ì¸í•œ í›¼ì†, ì‚¬ìš© í”ì ì´ ìˆì„ ê²½ìš° ë¶ˆê°€") }}</li>
                </ul>
              </td>
            </tr>
            <tr>
              <td class="font-semibold bg-gray-50 p-3">{{ _("ì·¨ì†Œ/í™˜ë¶ˆ ê·œì •") }}</td>
              <td class="p-3">
                {{ _("ìƒí’ˆ ì¤€ë¹„ ì¤‘ ìƒíƒœì—ì„œëŠ” ì·¨ì†Œ ê°€ëŠ¥í•˜ë©°, ë°°ì†¡ ì´í›„ì—ëŠ” ë°˜í’ˆ ì ˆì°¨ë¥¼ í†µí•´ ì²˜ë¦¬ë©ë‹ˆë‹¤") }}.
              </td>
            </tr>
          </tbody>
        </table>
        <div class="text-right mt-2">
          <span class="text-xs text-gray-500">â€» {{ _("ë³¸ ìƒí’ˆì •ë³´ëŠ” ì „ììƒê±°ë˜ ë“±ì—ì„œì˜ ìƒí’ˆì •ë³´ì œê³µê³ ì‹œì— ë”°ë¼ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤") }}.</span>
        </div>
      </div>

      <!-- âœ… ì£¼ì˜ì‚¬í•­ -->
      <div class="mt-12 border-t pt-6">
        <h3 class="text-xl font-bold mb-4 text-gray-800">{{ _("ì£¼ì˜ì‚¬í•­") }}</h3>
        <ul class="list-decimal pl-5 text-gray-700 space-y-2 text-sm leading-relaxed">
          <li>{{ _("ì „ììƒê±°ë˜ ë“±ì—ì„œì˜ ì†Œë¹„ìë³´í˜¸ë²•ì— ë”°ë¼ ë¯¸ì„±ë…„ìê°€ ë¬¼í’ˆì„ êµ¬ë§¤í•˜ëŠ” ê²½ìš°, ë²•ì •ëŒ€ë¦¬ì¸ì˜ ë™ì˜ê°€ ì—†ìœ¼ë©´ êµ¬ë§¤ë¥¼ ì·¨ì†Œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤") }}.</li>
          <li>{{ _("ë³¸ ì‚¬ì´íŠ¸ì— ë“±ë¡ëœ ëª¨ë“  ìƒí’ˆì€ ì£¼ì‹íšŒì‚¬ ìœ ê°€ì—ì„œ ì§ì ‘ íŒë§¤Â·ê´€ë¦¬í•˜ëŠ” ì •í’ˆì´ë©°, ì œí’ˆ ì •ë³´ì™€ ê°€ê²©ì€ ì‚¬ì „ ì˜ˆê³  ì—†ì´ ë³€ê²½ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤") }}.</li>
          <li>{{ _("ê²°ì œ ë° ë°°ì†¡ì€ ë‹¹ì‚¬ ì‹œìŠ¤í…œì„ í†µí•´ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬ë˜ë©°, ì£¼ë¬¸Â·ê²°ì œ ê´€ë ¨ ë¬¸ì˜ëŠ” ê³ ê°ì„¼í„°ë¥¼ í†µí•´ ì‹ ì†íˆ ì•ˆë‚´ë°›ìœ¼ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤") }}.</li>
        </ul>
      </div>
    </div>

    <!-- ë¦¬ë·° -->
    <div id="tab-reviews" class="tab-content p-6 sm:p-8 hidden">
      <h2 class="text-xl sm:text-2xl font-bold mb-4 text-gray-800">ğŸ“ {{ _("ìƒí’ˆ ë¦¬ë·°") }}</h2>
      {% if product.reviews %}
        {% for r in product.reviews %}
        <div class="border-b pb-3 mb-4 bg-white shadow-sm rounded-lg p-4 hover:shadow-md transition">
          <p class="text-yellow-500 text-lg">
            {% for i in range(r.rating) %}â˜…{% endfor %}
            {% for i in range(5 - r.rating) %}â˜†{% endfor %}
          </p>
          <p class="text-gray-800 text-sm sm:text-base mt-1">{{ r.content }}</p>
          <p class="text-sm text-gray-500 mt-2">{{ r.user.name }} Â· {{ r.created_at.strftime("%Y-%m-%d") }}</p>
        </div>
        {% endfor %}
      {% else %}
        <p class="text-gray-500">{{ _("ì•„ì§ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.") }}</p>
      {% endif %}

      {% if current_user.is_authenticated %}
      <form method="post" action="{{ url_for('add_review', product_id=product.id) }}" class="mt-6 bg-gray-50 p-6 shadow rounded-xl">
        <h3 class="font-bold text-lg mb-3">{{ _("ë¦¬ë·° ì‘ì„±í•˜ê¸°") }}</h3>
        <label class="block font-semibold text-sm mb-1">{{ _("ë³„ì ") }}</label>
        <select name="rating" class="border rounded p-2 mb-3 w-28">
          {% for i in range(1,6) %}
            <option value="{{ i }}">{{ i }}{{ _("ì ") }}</option>
          {% endfor %}
        </select>

        <label class="block font-semibold text-sm mb-1">{{ _("ë¦¬ë·° ë‚´ìš©") }}</label>
        <textarea name="content" class="border rounded w-full p-3 mb-3 focus:ring-2 focus:ring-indigo-300" rows="3"></textarea>

        <button type="submit" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 shadow">
          {{ _("ë“±ë¡") }}
        </button>
      </form>
      {% endif %}
    </div>
  </div>
</div>

<!-- ğŸ›’ ì‚¬ì´ë“œë°” -->
<div id="floating-cart"
     class="fixed top-0 right-0 h-full w-72 sm:w-80 bg-white border-l shadow-2xl transform translate-x-full transition-transform duration-300 z-50 p-4 sm:p-6">

  <!-- ë°˜ì› í† ê¸€ -->
    <div id="cart-toggle"
        onclick="toggleCart()"
        class="absolute top-1/2 -left-6 transform -translate-y-1/2 
                w-6 h-16 bg-[#f9fafb] text-white flex items-center justify-center 
                cursor-pointer rounded-l-full shadow-lg transition-all duration-500">
        <span class="text-gray-400" id="cart-toggle-icon">â®œ</span>
    </div>

    <img src="{{ url_for('serve_product_image', product_id=product.id) }}"
       class="top-4 rounded-lg shadow mb-4 object-cover h-40 w-full">

    <h4 class="text-base font-bold mb-1">{{ _(product.name) }}</h4>
    <p class="text-indigo-600 font-semibold mb-4">{{ _("%(price)sì›", price=product.base_price|int|won) }}</p>

    <!-- ìˆ˜ëŸ‰ -->
    <div class="mb-4 flex items-center">
      <label class="mr-3 font-semibold text-sm sm:text-base">{{ _("ìˆ˜ëŸ‰") }}</label>
      <div class="flex items-center">
        <button type="button" onclick="changeQuantity('side', -1)"
                class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-2 sm:px-3 py-1 sm:py-2 rounded-l">-</button>
        <input id="quantity-side" type="number" value="1" min="1" 
              class="w-14 sm:w-16 text-center border-t border-b p-1 sm:p-2 text-sm sm:text-base">
        <button type="button" onclick="changeQuantity('side', 1)"
                class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-2 sm:px-3 py-1 sm:py-2 rounded-r">+</button>
      </div>
    </div>

  <form id="cart-form-side" method="post" action="/add_to_cart">
    <input type="hidden" name="product_id" value="{{ product.id }}">
    <input type="hidden" id="cart-quantity-side" name="quantity" value="1">

    {% if option_keys %}
      {% for key in option_keys %}
      <label class="block font-semibold mb-2 text-sm text-gray-700">{{ _(key) }}</label>
      <select name="option_{{ key }}" class="border rounded w-full p-2 mb-4 text-sm option-select-side" data-key="{{ key }}">
        <option value="">-- {{ _("ì„ íƒí•˜ì„¸ìš”") }} --</option>
        {% set values = [] %}
        {% for v in product.variants %}
          {% if v.options[key] not in values %}
            <option value="{{ v.options[key] }}">{{ _(v.options[key]) }}</option>
            {% set _ = values.append(v.options[key]) %}
          {% endif %}
        {% endfor %}
      </select>
      {% endfor %}
    {% endif %}

    <button type="submit"
            class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 shadow transition">
      {{ _("ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°") }}
    </button>
  </form>

  <!-- ìœ„ë¡œê°€ê¸° ë²„íŠ¼ -->
  <button onclick="window.scrollTo({ top: 0, behavior: 'smooth' })"
    class="absolute bottom-6 left-1/2 transform -translate-x-1/2 
           bg-gray-200 hover:bg-indigo-500 hover:text-white text-gray-600 
           rounded-full w-10 sm:w-12 h-10 sm:h-12 flex items-center justify-center shadow-lg text-sm sm:text-base">
    â†‘
  </button>
</div>

<!-- ëª¨ë‹¬ -->
<div id="cart-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50">
  <div class="bg-white p-4 sm:p-6 rounded-lg shadow-lg text-center w-72 sm:w-80">
    <p class="mb-3 sm:mb-4 text-base sm:text-lg font-semibold">{{ _("ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤") }}!</p>
    <div class="flex justify-around gap-2 sm:gap-4">
      <button onclick="closeModal()" 
              class="whitespace-nowrap px-4 sm:px-4 py-2 bg-gray-200 rounded hover:bg-gray-300 text-sm font-medium sm:text-base">
        {{ _("ê³„ì† ì‡¼í•‘í•˜ê¸°") }}
      </button>
      <a href="/checkout" 
         class="whitespace-nowrap px-4 sm:px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 text-sm font-medium sm:text-base">
        {{ _("ì¥ë°”êµ¬ë‹ˆ ì´ë™") }}
      </a>
    </div>
  </div>
</div>

<script>
let userClosed = false;

// ë°˜ì› í† ê¸€ ë²„íŠ¼ìœ¼ë¡œ ì—´ê³  ë‹«ê¸°
function toggleCart() {
  const cart = document.getElementById("floating-cart");
  const icon = document.getElementById("cart-toggle-icon");

  cart.classList.toggle("translate-x-full");

  if (cart.classList.contains("translate-x-full")) {
    icon.textContent = "â®œ"; // ë‹«í˜
    userClosed = true;
  } else {
    icon.textContent = "â®"; // ì—´ë¦¼
    userClosed = false;
  }
}

// ìŠ¤í¬ë¡¤ ì‹œ ìë™ ì—´ê¸° (PC ì „ìš©)
window.addEventListener("scroll", function() {
  const cart = document.getElementById("floating-cart");
  const icon = document.getElementById("cart-toggle-icon");

  // âœ… PC(1024px ì´ìƒ)ì—ì„œë§Œ ìë™ ì—´ë¦¼
  if (window.innerWidth >= 1024 && window.scrollY > 1000 && cart.classList.contains("translate-x-full") && !userClosed) {
    cart.classList.remove("translate-x-full");
    icon.textContent = "â®";
  }
});

// ì˜µì…˜ ì„ íƒ ì‹œ hidden inputì— ë°˜ì˜
document.querySelectorAll(".option-select, .option-select-side").forEach(select => {
  select.addEventListener("change", () => {
    const key = select.dataset.key;
    const value = select.value;

    // ë©”ì¸ hidden ì—…ë°ì´íŠ¸
    const cartMain = document.getElementById("cart-option-main-" + key);
    if (cartMain) cartMain.value = value;
  });
});

// ìˆ˜ëŸ‰ ì¡°ì •
function changeQuantity(target, delta) {
  const input = document.getElementById(`quantity-${target}`);
  if (!input) return;
  let value = parseInt(input.value) || 1;
  value = Math.max(1, value + delta);
  input.value = value;

  const cartQty = document.getElementById(`cart-quantity-${target}`);
  if (cartQty) cartQty.value = value;
}

// Ajaxë¡œ ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°
function attachCartHandler(formId) {
  const form = document.getElementById(formId);
  if (!form) return;

  form.addEventListener("submit", function(e) {
    e.preventDefault();
    const formData = new FormData(this);

    fetch("/add_to_cart", {
      method: "POST",
      body: formData,
      headers: { "X-Requested-With": "XMLHttpRequest" }
    })
    .then(res => res.json())
    .then(data => {
      if (data.status === "ok") {
        document.dispatchEvent(new CustomEvent('cart:added'));
        document.getElementById("cart-modal").classList.remove("hidden");
      } else {
        alert(data.message);
      }
    })
    .catch(err => console.error("ì—ëŸ¬ ë°œìƒ:", err));
  });
}

attachCartHandler("cart-form-main");
attachCartHandler("cart-form-side");

function closeModal() {
  document.getElementById("cart-modal").classList.add("hidden");
}
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const tabs = document.querySelectorAll(".tab-btn");
  const contents = document.querySelectorAll(".tab-content");

  tabs.forEach(tab => {
    tab.addEventListener("click", () => {
      tabs.forEach(t => t.classList.remove("text-indigo-600", "border-indigo-600", "active-tab"));
      contents.forEach(c => c.classList.add("hidden"));

      tab.classList.add("text-indigo-600", "border-indigo-600");
      document.getElementById(`tab-${tab.dataset.tab}`).classList.remove("hidden");
    });
  });
});
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const optionSelectsMain = document.querySelectorAll(".option-select");
  const optionSelectsSide = document.querySelectorAll(".option-select-side");
  const basePrice = parseInt({{ product.base_price|int }});
  const variants = {{ variants_json|safe }};
  const priceDisplayMain = document.querySelector("#purchase-box .text-indigo-600");
  const priceDisplaySide = document.querySelector("#floating-cart .text-indigo-600");

  // ğŸ’¡ ê°€ê²© ê°±ì‹  í•¨ìˆ˜ (ì˜µì…˜ ì¡°í•© ì™„ë£Œ ì‹œì—ë§Œ ìƒˆê°€ê²© í‘œì‹œ)
  function updatePrice(target = "main") {
    const optionSelects = target === "main" ? optionSelectsMain : optionSelectsSide;
    const priceDisplay = target === "main" ? priceDisplayMain : priceDisplaySide;

    // ì„ íƒëœ ì˜µì…˜ ì¡°í•©
    const selected = {};
    let allSelected = true;
    optionSelects.forEach(sel => {
      if (!sel.value) allSelected = false;
      selected[sel.dataset.key] = sel.value;
    });

    let newPrice = basePrice;
    let matchedVariant = null;

    if (allSelected) {
      // ëª¨ë“  ì˜µì…˜ì´ ì„ íƒëœ ê²½ìš°ë§Œ ê°€ê²© ì¡°í•© ê²€ì‚¬
      for (const v of variants) {
        let match = true;
        for (const k of Object.keys(selected)) {
          if (v.options[k] !== selected[k]) {
            match = false;
            break;
          }
        }
        if (match) {
          matchedVariant = v;
          break;
        }
      }

      if (matchedVariant && matchedVariant.price) {
        newPrice += parseInt(matchedVariant.price);
      }
    }

    // âœ… ê°€ê²© í‘œì‹œ ë¡œì§
    if (allSelected && newPrice !== basePrice) {
      priceDisplay.innerHTML = `
        <span class="old-price">${basePrice.toLocaleString()}ì›</span>
        <span class="new-price">${newPrice.toLocaleString()}ì›</span>
      `;
    } else {
      // ì•„ì§ ëª¨ë“  ì˜µì…˜ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìœ¼ë©´ ê¸°ë³¸ê°€ë§Œ í‘œì‹œ
      priceDisplay.textContent = basePrice.toLocaleString() + "ì›";
    }
  }

  // ì˜µì…˜ ë³€ê²½ ì‹œ ì¦‰ì‹œ ë°˜ì˜
  optionSelectsMain.forEach(sel => sel.addEventListener("change", () => updatePrice("main")));
  optionSelectsSide.forEach(sel => sel.addEventListener("change", () => updatePrice("side")));

  // í˜ì´ì§€ ì§„ì… ì‹œ ê¸°ë³¸ê°€ í‘œì‹œ
  priceDisplayMain.textContent = basePrice.toLocaleString() + "ì›";
  priceDisplaySide.textContent = basePrice.toLocaleString() + "ì›";
});
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const wrapper = document.getElementById("pamphlet-wrapper");
  const toggleBtn = document.getElementById("toggle-info-btn");
  if (!wrapper || !toggleBtn) return;

  let expanded = false;
  toggleBtn.addEventListener("click", () => {
    expanded = !expanded;
    wrapper.classList.toggle("max-h-[950px]", !expanded);
    wrapper.classList.toggle("expanded", expanded);
    toggleBtn.textContent = expanded ? "ìƒì„¸ì •ë³´ ì ‘ê¸° â–²" : "ìƒì„¸ì •ë³´ ë”ë³´ê¸° â–¼";
  });
});
</script>

<style>
.old-price {
  text-decoration: line-through;
  color: #9ca3af; /* gray-400 */
  margin-right: 8px;
  font-size: 0.95em;
}

.new-price {
  color: #4f46e5; /* indigo-600 */
  font-weight: 700;
  font-size: 1.1em;
}
</style>

<style>
/* âœ… ìƒì„¸ì •ë³´ í•˜ë‹¨ íë¦¼ íš¨ê³¼ (gradient fade) */
.fade-overlay {
  background: linear-gradient(to top, rgba(255,255,255,1), rgba(255,255,255,0));
  transition: opacity 0.4s ease;
}

/* í¼ì³¤ì„ ë•Œ íë¦¼ íš¨ê³¼ ì‚¬ë¼ì§ */
#pamphlet-wrapper.expanded .fade-overlay {
  opacity: 0;
}
</style>
{% endblock %}
