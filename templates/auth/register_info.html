{% extends "base.html" %}
{% block content %}
<div class="max-w-2xl mx-auto p-10 bg-white shadow-2xl rounded-2xl mt-16 border border-gray-100">

  <!-- ✅ PC 전용 -->
  <div class="hidden sm:block">
    <h2 class="text-3xl font-extrabold text-center text-[#222] mb-10">{{ _("회원 정보 입력") }}</h2>

    <form method="post" id="register-form" class="space-y-6 text-base">
      <!-- 이메일 -->
      <div>
        <label class="block font-semibold mb-2 text-gray-700">{{ _("이메일") }}</label>
        <div class="flex space-x-2 mb-2">
          <input type="email" id="email_verify" name="email" value="{{ email or '' }}" placeholder="{{ _('이메일 입력') }}" 
                class="border border-gray-300 p-2 rounded-lg flex-1 focus:ring-2 focus:ring-indigo-300 focus:border-indigo-400 transition">
          <button type="button" id="send-email-btn" onclick="sendEmailCode()"
                  class="bg-white border border-gray-400 text-[#222] px-3 py-2 rounded-lg hover:opacity-90 active:scale-[0.97] transition">
            {{ _("인증메일 보내기") }}
          </button>
        </div>

        <div class="flex space-x-2">
          <input type="text" id="verify_email_code" placeholder="{{ _('인증코드 입력') }}"
                class="border border-gray-300 p-2 rounded-lg flex-1 focus:ring-2 focus:ring-green-300 focus:border-green-400 transition">
          <button type="button" onclick="verifyEmailCode()" 
                  class="bg-green-600 text-white px-3 py-2 rounded-lg hover:bg-green-700 active:scale-[0.97] transition">
            {{ _("인증 확인") }}
          </button>
        </div>
        <p id="email-status" class="text-sm mt-1 text-gray-500"></p>
      </div>

      <!-- 비밀번호 -->
      <div>
        <label class="block font-semibold mb-2 text-gray-700">{{ _("비밀번호") }}</label>
        <input type="password" id="password" name="password" placeholder="{{ _('비밀번호') }}"
               required class="w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-indigo-300 focus:border-indigo-400 transition"
               oninput="checkPasswordStrength(this.value)">
        <div class="w-full bg-gray-200 rounded-full h-2 mt-3">
          <div id="pw-strength" class="h-2 rounded-full transition-all duration-300"></div>
        </div>
        <p id="pw-strength-text" class="text-sm text-gray-600 mt-2"></p>
        <!-- ✅ 한 줄 설명 -->
        <p class="text-xs text-gray-500 mt-1">{{ _("8자 이상이며 숫자와 특수문자를 포함해야 합니다") }}.</p>
      </div>

      <!-- 비밀번호 확인 -->
      <div>
        <label class="block font-semibold mb-2 text-gray-700">{{ _("비밀번호 확인") }}</label>
        <input type="password" id="password_confirm" name="password_confirm" placeholder="{{ _('비밀번호 확인') }}"
               required class="w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-indigo-300 focus:border-indigo-400 transition"
       oninput="checkPasswordMatch()">
        <p id="pw-match-text" class="text-sm mt-2"></p>
      </div>

      <!-- 이름 -->
      <div>
        <label class="block font-semibold mb-1 text-gray-700">{{ _("이름") }}</label>
        <input type="text" name="name" placeholder="{{ _('이름') }}" value="{{ name or '' }}"
               required class="w-full border border-gray-300 p-2 rounded-lg focus:ring-2 focus:ring-indigo-300 focus:border-indigo-400 transition">
      </div>

      <!-- 주소 -->
      <div>
        <label class="block font-semibold mb-1 text-gray-700">{{ _("주소") }}</label>
        <div class="flex space-x-2 mb-2">
          <input type="text" id="postcode" placeholder="{{ _('우편번호') }}"
                 class="border p-2 rounded-lg w-1/2 bg-gray-100" readonly>
          <button type="button" onclick="execDaumPostcode()"
                  class="px-3 py-2 bg-white border border-gray-400 text-[#222] rounded-lg hover:bg-gray-100 active:scale-[0.97] transition">
            {{ _("주소찾기") }}
          </button>
        </div>
        <input type="text" id="address" name="address" placeholder="{{ _('기본주소') }}" value="{{ base_address or '' }}"
               class="w-full border border-gray-300 p-2 rounded-lg mb-2 bg-gray-100" readonly>
        <input type="text" id="detailAddress" name="detail_address" placeholder="{{ _('상세주소') }}" value="{{ detail_address or '' }}"
               class="w-full border border-gray-300 p-2 rounded-lg focus:ring-2 focus:ring-indigo-300 focus:border-indigo-400 transition">
      </div>

      <!-- 휴대폰 번호 -->
      <div>
        <label class="block font-semibold mb-1 text-gray-700">{{ _("휴대폰 번호") }}</label>
        <div class="flex space-x-2">
          <input type="text" id="phone" name="phone" placeholder="예: 01012345678" value="{{ phone or '' }}"
                 class="border border-gray-300 p-2 rounded-lg flex-1 focus:ring-2 focus:ring-indigo-300 focus:border-indigo-400 transition">
          <!--<button type="button" onclick="sendCode()"
                  class="bg-white border border-gray-400 text-[#222] px-3 py-2 rounded-lg hover:opacity-90 active:scale-[0.97] transition">
            {{ _("인증번호 받기") }}
          </button>-->
        </div>
      </div>

      <!-- 인증번호 --><!--
      <div class="flex space-x-2">
        <input type="text" id="verify_code" placeholder="{{ _('인증번호 입력') }}"
               class="border border-gray-300 p-2 rounded-lg flex-1 focus:ring-2 focus:ring-green-300 focus:border-green-400 transition">
        <button type="button" onclick="verifyCode()"
                class="bg-green-600 text-white px-3 py-2 rounded-lg hover:bg-green-700 active:scale-[0.97] transition">
          {{ _("인증 확인") }}
        </button>
      </div>-->

      <!-- 가입 버튼 -->
      <button type="submit"
              class="w-full btn-dark text-white py-3 rounded-xl font-semibold hover:opacity-90 active:scale-[0.98] transition-all shadow-md mt-5">
        {{ _("가입하기") }}
      </button>
    </form>
  </div>

  <!-- ✅ 모바일 전용 (진행바 + 단계별 폼) -->
  <div class="block sm:hidden">
    <h2 class="text-2xl font-bold mb-6 text-center text-indigo-700">{{ _("회원가입") }}</h2>

    <!-- 진행 표시 -->
    <div class="mb-6">
      <div id="step-label" class="text-center text-sm font-semibold mb-2 text-gray-600">{{ _("진행상황") }} 1 / 5</div>
      <div class="w-full bg-gray-200 rounded-full h-2">
        <div id="progress-bar" class="bg-indigo-600 h-2 rounded-full transition-all duration-300" style="width:20%"></div>
      </div>
    </div>

    <!-- 단계별 폼 -->
    <form method="post" id="mobile-register-form">
      <!-- STEP 1 -->
      <div class="step" id="step1">
        <label class="block font-semibold mb-2">{{ _("이메일") }}</label>
        
        <!-- 이메일 입력 + 인증 버튼 -->
        <div class="flex space-x-2 mb-2">
          <input type="email" id="email_m" name="email" required
                class="w-full border p-2 rounded flex-1" placeholder="{{ _('이메일 입력') }}">
          <button type="button" id="send-email-btn-m" onclick="sendEmailCodeMobile()" 
                  class="bg-white border border-gray-400 text-[#222] px-3 py-2 rounded-lg hover:bg-gray-100 active:scale-[0.97] transition">
            {{ _("인증메일 보내기") }}
          </button>
        </div>

        <!-- 인증코드 입력 + 인증확인 -->
        <div class="flex space-x-2 mb-2">
          <input type="text" id="verify_email_code_m" placeholder="{{ _('인증코드 입력') }}"
                class="border border-gray-300 p-2 rounded flex-1 focus:ring-2 focus:ring-green-300 focus:border-green-400 transition">
          <button type="button" onclick="verifyEmailCodeMobile()" 
                  class="bg-green-600 text-white px-3 py-2 rounded-lg hover:bg-green-700 active:scale-[0.97] transition">
            {{ _("인증 확인") }}
          </button>
        </div>

        <p id="email-status-m" class="text-xs text-gray-500 mb-4"></p>

        <button type="button" onclick="nextStep(2)" class="w-full bg-indigo-600 text-white py-2 rounded">
          {{ _("다음") }}
        </button>
      </div>

      <!-- STEP 2 -->
      <div class="step hidden" id="step2">
        <label class="block font-semibold mb-2">{{ _("비밀번호") }}</label>
        <input type="password" name="password" required class="w-full border p-2 rounded mb-2" placeholder="{{ _('비밀번호') }}">
        <input type="password" name="password_confirm" required class="w-full border p-2 rounded mb-4" placeholder="{{ _('비밀번호 확인') }}">
        <div class="flex justify-between">
          <button type="button" onclick="prevStep(1)" class="bg-gray-300 px-4 py-2 rounded">{{ _("이전") }}</button>
          <button type="button" onclick="nextStep(3)" class="bg-indigo-600 text-white px-4 py-2 rounded">{{ _("다음") }}</button>
        </div>
      </div>

      <!-- STEP 3 -->
      <div class="step hidden" id="step3">
        <label class="block font-semibold mb-2">{{ _("이름") }}</label>
        <input type="text" name="name" required class="w-full border p-2 rounded mb-4" placeholder="{{ _('이름') }}">
        <div class="flex justify-between">
          <button type="button" onclick="prevStep(2)" class="bg-gray-300 px-4 py-2 rounded">{{ _("이전") }}</button>
          <button type="button" onclick="nextStep(4)" class="bg-indigo-600 text-white px-4 py-2 rounded">{{ _("다음") }}</button>
        </div>
      </div>

      <!-- STEP 4 -->
      <div class="step hidden" id="step4">
        <label class="block font-semibold mb-2">{{ _("주소") }}</label>
        <button type="button" onclick="execDaumPostcode()" class="w-full bg-indigo-600 text-white py-2 rounded mb-2">{{ _("주소 찾기") }}</button>
        <input type="text" id="address_m" name="address" readonly placeholder="{{ _('기본주소') }}" class="w-full border p-2 rounded mb-2">
        <input type="text" id="detailAddress_m" name="detail_address" placeholder="{{ _('상세주소') }}" class="w-full border p-2 rounded mb-4">
        <div class="flex justify-between">
          <button type="button" onclick="prevStep(3)" class="bg-gray-300 px-4 py-2 rounded">{{ _("이전") }}</button>
          <button type="button" onclick="nextStep(5)" class="bg-indigo-600 text-white px-4 py-2 rounded">{{ _("다음") }}</button>
        </div>
      </div>

      <!-- STEP 5 -->
      <div class="step hidden" id="step5">
        <label class="block font-semibold mb-2">{{ _("휴대폰 번호") }}</label>
        <input type="text" id="phone_m" name="phone" placeholder="01012345678" class="w-full border p-2 rounded mb-2">
        <!--<button type="button" onclick="sendCode()" class="w-full bg-indigo-600 text-white py-2 rounded mb-2">{{ _("인증번호 받기") }}</button>
        <input type="text" id="verify_code_m" placeholder="{{ _('인증번호 입력') }}" class="w-full border p-2 rounded mb-4">-->
        <div class="flex justify-between">
          <button type="button" onclick="prevStep(4)" class="bg-gray-300 px-4 py-2 rounded">{{ _("이전") }}</button>
          <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded">{{ _("가입하기") }}</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- ✅ 카카오 주소검색 -->
<script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script>
function execDaumPostcode() {
  new daum.Postcode({
    oncomplete: function(data) {
      const fullAddress = data.roadAddress || data.jibunAddress;

      // ✅ PC 입력 필드 존재 시 (데스크탑)
      const pcPostcode = document.getElementById("postcode");
      const pcAddress = document.getElementById("address");
      const pcDetail = document.getElementById("detailAddress");

      if (pcPostcode && pcAddress && pcDetail) {
        pcPostcode.value = data.zonecode;
        pcAddress.value = fullAddress;
        pcDetail.focus();
      }

      // ✅ 모바일 입력 필드 존재 시
      const mAddress = document.getElementById("address_m");
      const mDetail = document.getElementById("detailAddress_m");

      if (mAddress && mDetail) {
        mAddress.value = fullAddress;
        mDetail.focus();
      }
    }
  }).open();
}
</script>

<!-- ✅ 이메일 중복검사 -->
<script>
function checkEmail() {
  const email = document.getElementById("email").value.trim();
  const statusEl = document.getElementById("email-status");
  if (!email) {
    statusEl.textContent = "이메일을 입력해주세요.";
    statusEl.className = "text-xs text-red-500 mt-1";
    return;
  }
  fetch("/check_email", { method: "POST", body: new URLSearchParams({ email }) })
    .then(res => res.json())
    .then(data => {
      if (data.exists) {
        statusEl.textContent = "이미 사용 중인 이메일입니다.";
        statusEl.className = "text-xs text-red-500 mt-1";
      } else {
        statusEl.textContent = "사용 가능한 이메일입니다.";
        statusEl.className = "text-xs text-green-600 mt-1";
      }
    });
}
</script>

<!-- ✅ 비밀번호 강도 체크 -->
<script>
function checkPasswordStrength(password) {
  const bar = document.getElementById("pw-strength");
  const text = document.getElementById("pw-strength-text");

  const hasLength = password.length >= 8;
  const hasNumber = /[0-9]/.test(password);
  const hasSymbol = /[^A-Za-z0-9]/.test(password);

  let score = [hasLength, hasNumber, hasSymbol].filter(Boolean).length;
  const colors = ["#f87171", "#facc15", "#34d399"];
  const labels = ["약함", "보통", "강함"];

  bar.style.width = ["25%", "50%", "100%"][Math.min(score - 1, 2)] || "0%";
  bar.style.background = colors[Math.min(score - 1, 2)] || "#d1d5db";
  text.textContent = score < 3 ? `비밀번호 강도: ${labels[Math.min(score - 1, 2)] || '약함'}` : "비밀번호 강도: 매우 강함";
  text.className = `text-sm mt-1 ${score < 2 ? 'text-red-500' : score === 2 ? 'text-yellow-600' : 'text-green-600'}`;
}

function checkPasswordMatch() {
  const pw = document.getElementById("password").value;
  const pwc = document.getElementById("password_confirm").value;
  const text = document.getElementById("pw-match-text");

  if (!pwc) {
    text.textContent = "";
    return;
  }

  if (pw === pwc) {
    text.textContent = "비밀번호가 일치합니다.";
    text.className = "text-xs text-green-600 mt-2";
  } else {
    text.textContent = "비밀번호가 일치하지 않습니다.";
    text.className = "text-xs text-red-500 mt-2";
  }
}

// 제출 전 검증
document.getElementById("register-form").addEventListener("submit", e => {
  const pw = document.getElementById("password").value;
  const pwc = document.getElementById("password_confirm").value;
  const regex = /^(?=.*[0-9])(?=.*[^A-Za-z0-9]).{8,}$/;

  if (!regex.test(pw)) {
    e.preventDefault();
    alert("비밀번호는 8자 이상이며 숫자와 특수문자를 포함해야 합니다.");
    return false;
  }
  if (pw !== pwc) {
    e.preventDefault();
    alert("비밀번호 확인이 일치하지 않습니다.");
    return false;
  }
});
</script>

<!-- ✅ 인증 관련 -->
 <!--
<script>
function sendCode() {
  const phone = document.getElementById("phone").value;
  if (!phone) return alert("휴대폰 번호를 입력해주세요.");
  fetch("/send_verification_code", {
    method: "POST",
    body: new URLSearchParams({ phone })
  }).then(r => r.json()).then(data => alert(data.message));
}

function verifyCode() {
  const code = document.getElementById("verify_code").value;
  if (!code) return alert("인증번호를 입력해주세요.");
  fetch("/verify_code", {
    method: "POST",
    body: new URLSearchParams({ code })
  }).then(r => r.json()).then(data => alert(data.message));
}
</script>
-->
<script>
let currentStep = 1;
const totalSteps = 5;

// 진행바 업데이트
function updateProgress() {
  const percent = (currentStep / totalSteps) * 100;
  document.getElementById("progress-bar").style.width = percent + "%";
  document.getElementById("step-label").innerText = `진행상황 ${currentStep} / ${totalSteps}`;
}

// 현재 스텝 검증
function validateStep(step) {
  if (step === 1) {
    const email = document.querySelector("#step1 input[name='email']").value.trim();
    if (!email) {
      alert("이메일을 입력해주세요.");
      return false;
    }
    const pattern = /^[^@\s]+@[^@\s]+\.[^@\s]+$/;
    if (!pattern.test(email)) {
      alert("올바른 이메일 형식을 입력해주세요.");
      return false;
    }
  }
  if (step === 2) {
    const pw = document.querySelector("#step2 input[name='password']").value.trim();
    const pwc = document.querySelector("#step2 input[name='password_confirm']").value.trim();
    const regex = /^(?=.*[0-9])(?=.*[^A-Za-z0-9]).{8,}$/;
    if (!regex.test(pw)) {
      alert("비밀번호는 8자 이상이며 숫자와 특수문자를 포함해야 합니다.");
      return false;
    }
    if (pw !== pwc) {
      alert("비밀번호 확인이 일치하지 않습니다.");
      return false;
    }
  }
  if (step === 3) {
    const name = document.querySelector("#step3 input[name='name']").value.trim();
    if (!name) {
      alert("이름을 입력해주세요.");
      return false;
    }
  }
  if (step === 4) {
    const addr = document.querySelector("#address_m").value.trim();
    const detail = document.querySelector("#detailAddress_m").value.trim();
    if (!addr || !detail) {
      alert("주소와 상세주소를 입력해주세요.");
      return false;
    }
  }
  if (step === 5) {
    const phone = document.querySelector("#phone_m").value.trim();
    if (!/^\d{10,11}$/.test(phone)) {
      alert("올바른 휴대폰 번호를 입력해주세요.");
      return false;
    }
  }
  return true;
}

// 다음 단계
function nextStep(step) {
  if (!validateStep(currentStep)) return;
  document.getElementById(`step${currentStep}`).classList.add("hidden");
  document.getElementById(`step${step}`).classList.remove("hidden");
  currentStep = step;
  updateProgress();
}

// 이전 단계
function prevStep(step) {
  document.getElementById(`step${currentStep}`).classList.add("hidden");
  document.getElementById(`step${step}`).classList.remove("hidden");
  currentStep = step;
  updateProgress();
}

// 초기화
updateProgress();
</script>

<!-- 데스크탑 이메일 인증 -->
<script>
function sendEmailCode() {
  const email = document.getElementById("email_verify").value.trim();
  const btn = document.getElementById("send-email-btn");
  const statusEl = document.getElementById("email-status");

  if (!email) return alert("이메일을 입력해주세요.");

  btn.disabled = true;
  btn.innerHTML = `<span>확인 중...</span><div class='loading-spinner'></div>`;
  
  fetch("/check_email", {
    method: "POST",
    credentials: "include", // ✅ 세션 유지
    body: new URLSearchParams({ email })
  })
  .then(res => res.json())
  .then(data => {
    if (data.exists) {
      statusEl.textContent = "이미 가입된 이메일입니다.";
      statusEl.className = "text-xs text-red-500 mt-1";
      btn.disabled = false;
      btn.innerHTML = `<span>인증메일 보내기</span>`;
      throw new Error("duplicate");
    }

    // 2️⃣ 중복 아니면 인증메일 발송
    btn.innerHTML = `<span>전송 중...</span><div class='loading-spinner'></div>`;
    return fetch("/send_email_code", {
      method: "POST",
      body: new URLSearchParams({ email })
    });
  })
  .then(res => res.json())
  .then(data => {
    alert(data.message);
    statusEl.textContent = "인증메일이 발송되었습니다.";
    statusEl.className = "text-xs text-green-600 mt-1";
  })
  .catch(err => {
    if (err.message !== "duplicate") {
      alert("이메일 전송 중 오류가 발생했습니다.");
      console.error(err);
    }
  })
  .finally(() => {
    btn.disabled = false;
    btn.innerHTML = `<span>인증메일 보내기</span>`;
  });
}

function verifyEmailCode() {
  const code = document.getElementById("verify_email_code").value.trim();
  const statusEl = document.getElementById("email-status");

  if (!code) return alert("인증코드를 입력해주세요.");

  fetch("/verify_email_code", {
    method: "POST",
    credentials: "include", // ✅ 세션 유지
    body: new URLSearchParams({ code })
  })
  .then(res => res.json())
  .then(data => {
    alert(data.message);

    if (data.message.includes("인증이 완료되었습니다")) {
      statusEl.textContent = "이메일 인증이 완료되었습니다!";
      statusEl.className = "text-xs text-green-600 mt-1 font-semibold";
    } else {
      statusEl.textContent = "인증에 실패했습니다. 다시 시도해주세요.";
      statusEl.className = "text-sm text-red-500 mt-1";
    }
  })
  .catch(err => {
    console.error(err);
    alert("서버 오류가 발생했습니다.");
  });
}
</script>

<!-- 모바일 이메일 인증 -->
<script>
function sendEmailCodeMobile() {
  const email = document.getElementById("email_m").value.trim();
  const btn = document.getElementById("send-email-btn-m");
  const statusEl = document.getElementById("email-status-m");

  if (!email) return alert("이메일을 입력해주세요.");

  btn.disabled = true;
  btn.innerHTML = `<span>확인 중...</span><div class='loading-spinner'></div>`;

  fetch("/check_email", {
    method: "POST",
    credentials: "include", // ✅ 세션 유지
    body: new URLSearchParams({ email })
  })
  .then(res => res.json())
  .then(data => {
    if (data.exists) {
      statusEl.textContent = "이미 가입된 이메일입니다.";
      statusEl.className = "text-xs text-red-500 mt-1";
      btn.disabled = false;
      btn.innerHTML = `<span>인증메일 보내기</span>`;
      throw new Error("duplicate");
    }

    // 2️⃣ 중복 아니면 인증메일 발송
    btn.innerHTML = `<span>전송 중...</span><div class='loading-spinner'></div>`;
    return fetch("/send_email_code", {
      method: "POST",
      body: new URLSearchParams({ email })
    });
  })
  .then(res => res.json())
  .then(data => {
    alert(data.message);
    statusEl.textContent = "인증메일이 발송되었습니다.";
    statusEl.className = "text-xs text-green-600 mt-1";
  })
  .catch(err => {
    if (err.message !== "duplicate") {
      alert("이메일 전송 중 오류가 발생했습니다.");
      console.error(err);
    }
  })
  .finally(() => {
    btn.disabled = false;
    btn.innerHTML = `<span>인증메일 보내기</span>`;
  });
}

function verifyEmailCodeMobile() {
  const code = document.getElementById("verify_email_code_m").value.trim();
  const statusEl = document.getElementById("email-status-m");

  if (!code) return alert("인증코드를 입력해주세요.");

  fetch("/verify_email_code", {
    method: "POST",
    credentials: "include", // ✅ 세션 유지
    body: new URLSearchParams({ code })
  })
  .then(res => res.json())
  .then(data => {
    alert(data.message);

    if (data.message.includes("인증이 완료되었습니다")) {
      statusEl.textContent = "✅ 이메일 인증이 완료되었습니다!";
      statusEl.className = "text-xs text-green-600 mt-1 font-semibold";
    } else {
      statusEl.textContent = "인증에 실패했습니다. 다시 시도해주세요.";
      statusEl.className = "text-xs text-red-500 mt-1";
    }
  })
  .catch(err => {
    console.error(err);
    alert("서버 오류가 발생했습니다.");
  });
}
</script>

<style>
input:focus { outline: none !important; box-shadow: 0 0 0 2px rgba(99,102,241,0.3); }
button { transition: all 0.2s ease; }
</style>
<style>
.loading-spinner {
  border: 2px solid #f3f3f3;
  border-top: 2px solid #4f46e5;
  border-radius: 50%;
  width: 16px;
  height: 16px;
  animation: spin 0.8s linear infinite;
  display: inline-block;
  vertical-align: middle;
  margin-left: 6px;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>
{% endblock %}
