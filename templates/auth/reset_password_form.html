{% extends "base.html" %}
{% block content %}
<div class="max-w-md mx-auto p-6 sm:p-8 bg-white shadow-lg rounded mt-10">
  <h2 class="text-2xl sm:text-3xl font-bold mb-6 text-center text-gray-600">
    {{ _("새 비밀번호 설정") }}
  </h2>

  <form method="post" id="reset-form" class="space-y-4 text-sm sm:text-base">
    <!-- 새 비밀번호 -->
    <div>
      <label class="block font-semibold mb-1">{{ _("새 비밀번호") }}</label>
      <input type="password" id="new_password" name="new_password" minlength="8"
             placeholder="영문+숫자+특수문자 포함 8자리 이상"
             required
             class="w-full border p-2 rounded focus:ring-2 focus:ring-indigo-400"
             oninput="checkPasswordStrength(this.value); checkPasswordMatch();">
      <div class="w-full bg-gray-200 rounded-full h-2 mt-3">
        <div id="pw-strength" class="h-2 rounded-full transition-all duration-300"></div>
      </div>
      <p id="pw-strength-text" class="text-sm text-gray-600 mt-2"></p>
      <p class="text-xs text-gray-500 mt-1">비밀번호는 8자 이상이며 숫자와 특수문자를 포함해야 합니다.</p>
    </div>

    <!-- 새 비밀번호 확인 -->
    <div>
      <label class="block font-semibold mb-1">{{ _("새 비밀번호 확인") }}</label>
      <input type="password" id="new_password_confirm" name="new_password_confirm" minlength="8"
             placeholder="{{ _('비밀번호 다시 입력') }}"
             required
             class="w-full border p-2 rounded focus:ring-2 focus:ring-indigo-400"
             oninput="checkPasswordMatch();">
      <p id="pw-match-text" class="text-sm mt-2"></p>
    </div>

    <!-- 버튼 -->
    <button type="submit"
            class="w-full bg-indigo-600 text-white py-2 rounded-lg font-semibold hover:bg-indigo-700 transition">
      {{ _("비밀번호 변경") }}
    </button>
  </form>

  <!-- 안내 문구 -->
  <p class="mt-6 text-xs text-gray-500 text-center">
    🔒 {{ _("비밀번호는 안전하게 암호화되어 저장됩니다.") }}<br>
    {{ _("다른 사이트에서 사용하지 않은 비밀번호를 입력하세요.") }}
  </p>
</div>

<script>
function checkPasswordStrength(password) {
  const bar = document.getElementById("pw-strength");
  const text = document.getElementById("pw-strength-text");

  const hasLength = password.length >= 8;
  const hasNumber = /[0-9]/.test(password);
  const hasSymbol = /[^A-Za-z0-9]/.test(password);

  let score = [hasLength, hasNumber, hasSymbol].filter(Boolean).length;
  const colors = ["#f87171", "#facc15", "#34d399"];
  const labels = ["약함", "보통", "강함"];

  bar.style.width = ["25%", "50%", "100%"][Math.min(score - 1, 2)] || "0%";
  bar.style.background = colors[Math.min(score - 1, 2)] || "#d1d5db";
  text.textContent = score < 3 ? `비밀번호 강도: ${labels[Math.min(score - 1, 2)] || '약함'}` : "비밀번호 강도: 매우 강함";
  text.className = `text-sm mt-1 ${score < 2 ? 'text-red-500' : score === 2 ? 'text-yellow-600' : 'text-green-600'}`;
}

function checkPasswordMatch() {
  const pw = document.getElementById("new_password").value;
  const pwc = document.getElementById("new_password_confirm").value;
  const text = document.getElementById("pw-match-text");

  if (!pwc) {
    text.textContent = "";
    return;
  }

  if (pw === pwc) {
    text.textContent = "✅ 비밀번호가 일치합니다.";
    text.className = "text-sm text-green-600 mt-2";
  } else {
    text.textContent = "❌ 비밀번호가 일치하지 않습니다.";
    text.className = "text-sm text-red-500 mt-2";
  }
}

// 제출 시 유효성 검사
document.getElementById("reset-form").addEventListener("submit", e => {
  const pw = document.getElementById("new_password").value;
  const pwc = document.getElementById("new_password_confirm").value;
  const regex = /^(?=.*[0-9])(?=.*[^A-Za-z0-9]).{8,}$/;

  if (!regex.test(pw)) {
    e.preventDefault();
    alert("비밀번호는 8자 이상이며 숫자와 특수문자를 포함해야 합니다.");
    return false;
  }
  if (pw !== pwc) {
    e.preventDefault();
    alert("비밀번호 확인이 일치하지 않습니다.");
    return false;
  }
});
</script>

<style>
input:focus { outline: none !important; box-shadow: 0 0 0 2px rgba(99,102,241,0.3); }
button { transition: all 0.2s ease; }
</style>
{% endblock %}
