{% extends "base.html" %}
{% block content %}
<div class="max-w-7xl mx-auto bg-white p-4 sm:p-6 shadow rounded mt-6 sm:mt-8">
  <h2 class="text-xl sm:text-2xl font-bold mb-4 sm:mb-6">문의 관리</h2>

  <!-- ✅ 필터 및 검색 영역 -->
  <div class="bg-gray-50 p-4 rounded-lg shadow-sm mb-5">
    <form id="filterForm" method="get" action="{{ url_for('admin_inquiries') }}" class="flex flex-wrap items-center gap-2">
      <!-- 기간 버튼 -->
      <button type="button" class="filter-btn px-3 py-1 rounded border border-gray-300 {% if selected_period == '5y' %}bg-green-100 text-green-700{% endif %}" data-range="5y">최대(5년)</button>
      <button type="button" class="filter-btn px-3 py-1 rounded border border-gray-300 {% if selected_period == '6m' %}bg-green-100 text-green-700{% endif %}" data-range="6m">6개월</button>
      <button type="button" class="filter-btn px-3 py-1 rounded border border-gray-300 {% if selected_period == '3m' %}bg-green-100 text-green-700{% endif %}" data-range="3m">3개월</button>
      <button type="button" class="filter-btn px-3 py-1 rounded border border-gray-300 {% if selected_period == '1m' %}bg-green-100 text-green-700{% endif %}" data-range="1m">1개월</button>

      <!-- 직접 날짜 입력 -->
      <div class="flex items-center gap-1 ml-2">
        <input type="month" id="startDate" name="start_date" class="border rounded p-1 text-sm" value="{{ start_date or '' }}">
        <span class="text-gray-500">~</span>
        <input type="month" id="endDate" name="end_date" class="border rounded p-1 text-sm" value="{{ end_date or '' }}">
      </div>

      <!-- 검색창 -->
      <input type="text" name="q" id="searchInquiry" placeholder="작성자명, 이메일, 제목, 내용 검색"
             class="border rounded px-2 py-1 flex-1 min-w-[200px] text-sm ml-2"
             value="{{ search_query or '' }}">

      <!-- 조회 버튼 -->
      <button type="submit" id="filterSearch" class="px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600 text-sm">
        조회하기
      </button>
    </form>
  </div>

  {% if inquiries|length == 0 %}
  <p class="text-gray-500 text-center py-10">검색 조건에 맞는 문의가 없습니다.</p>
  {% else %}
  {% for q in inquiries %}
  <div class="border rounded p-4 bg-white shadow mb-4 text-sm sm:text-base">
    <!-- 제목 -->
    <p class="font-bold break-words text-gray-800">제목: {{ q.title }}</p>

    <!-- 작성일 -->
    <p class="text-xs sm:text-sm text-gray-500">
      작성일: {{ q.created_at|kst }}
    </p>

    <!-- 작성자 -->
    <p class="text-xs sm:text-sm text-gray-600">
      작성자:
      {% if q.user %}
        {{ q.user.name }} ({{ q.user.email }})
      {% else %}
        비회원 ({{ q.guest_email }})
      {% endif %}
    </p>

    <!-- 본문 -->
    <p class="mt-2 whitespace-pre-line">{{ q.content }}</p>

    <!-- 답변 -->
    {% if q.answer %}
      <div class="mt-3 border-t pt-2">
        <p class="font-bold text-indigo-600">[답변]</p>
        <p class="whitespace-pre-line">{{ q.answer }}</p>
        <p class="text-xs text-gray-500">{{ q.answered_at|kst }}</p>
      </div>
    {% else %}
      <form method="POST" class="mt-3 space-y-2">
        <input type="hidden" name="inquiry_id" value="{{ q.id }}">
        <textarea name="answer" rows="3"
                  class="w-full border rounded p-2 text-sm sm:text-base"
                  placeholder="답변 내용을 입력하세요"></textarea>
        <button type="submit"
                class="w-full sm:w-auto bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 text-sm sm:text-base">
          답변 등록
        </button>
      </form>
    {% endif %}
  </div>
  {% endfor %}
  {% endif %}
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // ✅ 기본으로 '1개월' 버튼 선택되도록 설정
  const defaultPeriod = "{{ selected_period or '1m' }}";
  const form = document.getElementById("filterForm");
  document.querySelectorAll(".filter-btn").forEach(btn => {
    if (btn.dataset.range === defaultPeriod) {
      btn.classList.add("bg-green-100", "text-green-700");
    }
    btn.addEventListener("click", () => {
      const range = btn.dataset.range;
      const form = document.getElementById("filterForm");
      const hidden = document.createElement("input");
      hidden.type = "hidden";
      hidden.name = "period";
      hidden.value = range;
      form.appendChild(hidden);
      form.submit();
    });
  });
});
</script>
{% endblock %}
