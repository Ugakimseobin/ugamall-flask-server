{% extends "base.html" %}
{% block content %}
<div class="max-w-7xl mx-auto py-10 px-4 md:px-6">

  <div class="flex flex-col md:flex-row gap-8">
    <!-- ✅ 왼쪽 필터 -->
    <aside class="w-full md:w-1/4 bg-white shadow-lg rounded-2xl p-6 border border-gray-100">
      <!-- 모바일 토글 -->
      <button id="filter-toggle" class="w-full md:hidden bg-indigo-600 text-white py-2 rounded-lg mb-4 font-semibold">
        {{ _("필터 열기 / 닫기") }}
      </button>

      <div id="filter-box" class="hidden md:block">
        <h3 class="font-bold text-xl text-indigo-700 mb-6 flex items-center gap-2">
          <i class="font-bold text-[#222]">{{ _("상품 필터") }}</i> 
        </h3>

        <!-- 상품명 -->
        <div class="mb-5">
          <label class="block text-sm font-semibold mb-1 text-gray-700">{{ _("상품명") }}</label>
          <input id="filter-name" name="name"
                 class="border border-gray-300 p-2 w-full rounded-lg focus:ring-2 focus:ring-indigo-300"
                 placeholder="{{ _('예: 밴드, 보호대') }}"
                 value="{{ request.args.get('name', '') }}">
        </div>

        <!-- 분야 -->
        <div class="mb-5">
          <label class="block text-sm font-semibold mb-1 text-gray-700">{{ _("분야") }}</label>
          <select id="filter-category" name="category"
                  class="border border-gray-300 p-2 w-full rounded-lg focus:ring-2 focus:ring-indigo-300">
            <option value="">{{ _("전체 보기") }}</option>
            {% for cat in categories %}
              <option value="{{ cat }}" {% if request.args.get('category') == cat %}selected{% endif %}>{{ cat }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- 가격 -->
        <div class="mb-6">
          <label class="block text-sm font-semibold mb-2 text-gray-700">{{ _("가격 범위") }}</label>
          <div id="price-slider" class="mb-3"></div>

          <div class="flex items-center justify-between gap-2">
            <input id="price-min-input" type="number"
                  class="w-1/2 border border-gray-300 p-2 rounded-lg text-sm focus:ring-2 focus:ring-[#222]"
                  value="{{ request.args.get('price_min', 0) }}" min="0" step="1000">
            <span class="text-gray-400">~</span>
            <input id="price-max-input" type="number"
                  class="w-1/2 border border-gray-300 p-2 rounded-lg text-sm focus:ring-2 focus:ring-[#222]"
                  value="{{ request.args.get('price_max', 100000) }}" max="100000" step="1000">
          </div>
        </div>

        {% if video_filter %}
        <div class="mb-4">
          <label class="flex items-center space-x-2 text-sm font-semibold text-gray-700">
            <input type="checkbox" id="filter-video"
                   {% if request.args.get('video') == 'true' %}checked{% endif %}
                   class="accent-indigo-600">
            <span>{{ _("영상 포함") }}</span>
          </label>
        </div>
        {% endif %}

        <button id="apply-filters" data-baseurl="{{ url_for('search') }}"
                class="w-full bg-indigo-600 text-white font-semibold py-2.5 rounded-lg shadow hover:bg-indigo-700 transition">
          {{ _("필터 적용") }}
        </button>
      </div>
    </aside>

    <!-- ✅ 오른쪽 검색 결과 -->
    <section class="w-full md:w-3/4">
      <!-- 정렬바 -->
      <div class="flex flex-col sm:flex-row justify-between items-center mb-6 sm:mb-8 bg-white shadow rounded-xl p-4 border border-gray-100">
        <div class="text-gray-700 font-semibold text-sm sm:text-base">
          {{ _("총")}} <span class="text-indigo-600">{{ products|length }}</span>{{ _("개 결과")}}
        </div>
        <div class="flex items-center space-x-3 mt-3 sm:mt-0">
          <label for="sort" class="text-sm font-medium text-gray-600">{{ _("정렬") }}</label>
          <select id="sort" name="sort"
                  class="border border-gray-300 rounded-lg px-2 py-1 text-sm focus:ring-2 focus:ring-indigo-300">
            <option value="relevance" {% if request.args.get('sort') == 'relevance' %}selected{% endif %}>{{ _("관련순") }}</option>
            <option value="new" {% if request.args.get('sort') == 'new' %}selected{% endif %}>{{ _("최신순") }}</option>
            <option value="low" {% if request.args.get('sort') == 'low' %}selected{% endif %}>{{ _("낮은 가격순") }}</option>
            <option value="high" {% if request.args.get('sort') == 'high' %}selected{% endif %}>{{ _("높은 가격순") }}</option>
            <option value="name" {% if request.args.get('sort') == 'name' %}selected{% endif %}>{{ _("이름순") }}</option>
          </select>
        </div>
      </div>

      {% if products|length == 0 %}
        <div class="text-center text-gray-500 py-16 text-lg">
          <span class="font-semibold text-indigo-600">"{{ q }}"</span>{{ _(" 에 대한 검색 결과가 없습니다.") }}
        </div>
      {% else %}
      <!-- 상품 카드 -->
      <div class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 gap-6">
        {% for p in products %}
        <a href="{{ url_for('product_detail', product_id=p.id) }}"
           class="block bg-white rounded-2xl shadow-md hover:shadow-xl overflow-hidden transform hover:-translate-y-1 transition duration-300">
          <img src="{{ url_for('serve_product_image', product_id=p.id) }}"
               alt="{{ p.name }}"
               class="h-48 sm:h-56 w-full object-cover transition-transform duration-300 hover:scale-105">
          <div class="p-4">
            <h3 class="font-bold text-gray-800 text-sm sm:text-base truncate">{{ p.name }}</h3>
            <p class="text-indigo-600 font-semibold text-sm sm:text-base mt-1">{{ p.base_price|won }}원</p>
          </div>
        </a>
        {% endfor %}
      </div>
      {% endif %}

      {% if videos %}
      <section class="mt-10">
        <h2 class="text-xl font-bold mb-4">관련 영상</h2>
        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
          {% for video in videos %}
            <div class="bg-white shadow rounded-lg overflow-hidden">
              <video controls class="w-full">
                <source src="{{ url_for('serve_video', video_id=video.id) }}" type="{{ video.video_mime }}">
                {{ _("브라우저가 비디오를 지원하지 않습니다.") }}
              </video>
              <div class="p-3">
                <p class="font-semibold text-gray-800 text-sm">{{ video.title }}</p>
              </div>
            </div>
          {% endfor %}
        </div>
      </section>
      {% endif %}
    </section>
  </div>
</div>

<script>
document.getElementById("apply-filters").addEventListener("click", applyFilters);
document.getElementById("sort").addEventListener("change", applyFilters);

function applyFilters() {
  const name = document.getElementById("filter-name").value;
  const category = document.getElementById("filter-category").value;
  const priceMin = document.getElementById("price-min-input").value;
  const priceMax = document.getElementById("price-max-input").value;
  const video = document.getElementById("filter-video")?.checked ? "true" : "false";
  const sort = document.getElementById("sort").value;

  let url = new URL("{{ url_for('search') }}", window.location.origin);
  url.searchParams.set("name", name);
  url.searchParams.set("category", category);
  url.searchParams.set("price_min", priceMin);
  url.searchParams.set("price_max", priceMax);
  url.searchParams.set("video", video);
  url.searchParams.set("sort", sort);

  window.location.href = url.toString();
}

// ✅ 모바일 필터 토글
document.getElementById("filter-toggle").addEventListener("click", () => {
  document.getElementById("filter-box").classList.toggle("hidden");
});
</script>
{% endblock %}
