{% extends "base.html" %}
{% block content %}
<div class="max-w-5xl mx-auto py-6 sm:py-10 px-4 sm:px-6">
  <!-- 상단 헤더 -->
  <div class="bg-white shadow rounded-lg p-4 sm:p-6 mb-6 flex flex-col items-start text-left">
    <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">{{ _("주문 / 결제") }}</h1>
    {% if cart_items %}
      <div class="text-sm sm:text-base text-gray-600 mt-2 sm:mt-0 pt-4">
        총 <span id="cart-count" class="font-semibold text-indigo-600">{{ cart_items|length }}</span>개 상품
      </div>
    {% endif %}
  </div>

    <form method="post" id="checkout-form">
        <!-- 장바구니 -->
        <div class="bg-white shadow rounded p-4 sm:p-6 mb-8">
            {% if cart_items %}
                <div class="flex items-center justify-between mb-4 border-b pb-3">
                  <div class="flex items-center gap-4">
                    <label class="custom-checkbox flex-shrink-0 mr-2 sm:mr-4">
                      <input type="checkbox" id="select-all" class="all-checkbox">
                      <span class="checkmark"></span>
                       <p class="pl-2">전체 선택</p>
                    </label>
                    <button type="button" id="delete-selected" class="text-sm text-red-500 hover:text-red-700">
                      선택 삭제
                    </button>
                  </div>
                  <div class="text-gray-600 text-sm">
                    선택된 상품: <span id="selected-count" class="font-semibold text-indigo-600">0</span>개
                  </div>
                </div>
                {% for item in cart_items %}
                <div class="cart-item bg-white border rounded-lg shadow-sm p-4 mb-4 sm:flex sm:items-start sm:gap-5"
                      data-id="{{ item.id }}"
                      data-price="{{ item.product.base_price + (item.variant.price if item.variant and item.variant.price else 0) }}">
                    
                    <!-- 왼쪽 체크박스 -->
                    <div class="flex items-start sm:flex-col sm:items-center sm:pt-1">
                      <label class="custom-checkbox flex items-center sm:mb-2">
                        <input type="checkbox" name="selected_items" value="{{ item.id }}" class="item-checkbox">
                        <span class="checkmark ml-1"></span>
                      </label>
                    </div>

                    <!-- 중앙: 상품 이미지 -->
                    <div class="flex-shrink-0 w-full sm:w-32 h-40 sm:h-32 rounded-md overflow-hidden border">
                      <img src="{{ url_for('serve_product_image', product_id=item.product.id) }}"
                          alt="{{ item.product.name }}"
                          class="w-full h-full object-cover">
                    </div>

                    <!-- 우측 정보 -->
                    <div class="flex flex-col justify-between flex-1 mt-3 sm:mt-0 text-left">
                      <!-- 상단: 이름, 태그 -->
                      <div>
                        <div class="flex items-center gap-2 mb-1">
                          <span class="bg-green-100 text-green-700 text-xs font-medium px-2 py-0.5 rounded">빠른배송</span>
                        </div>
                        <p class="font-bold text-gray-900 text-base leading-snug">{{ item.product.name }}</p>

                        <p class="text-gray-500 text-xs sm:text-sm mt-1">
                          {% if item.variant %}
                            {% for key, val in item.variant.options.items() %}
                              {{ key }}: {{ val }}{% if not loop.last %} / {% endif %}
                            {% endfor %}
                          {% else %}
                            기본상품
                          {% endif %}
                          / <span class="option-qty-text">{{ item.quantity }}개</span>
                        </p>
                      </div>

                      <!-- 중간: 가격 -->
                      <div class="mt-2">
                        <div class="flex items-center gap-2">
                          <span class="text-[#222] font-bold text-lg sm:text-xl">
                            {{ (item.product.base_price + (item.variant.price if item.variant and item.variant.price else 0)) | int | format }}원
                          </span>
                        </div>
                      </div>

                      <!-- 하단: 수량 조절 + 삭제 -->
                      <div class="mt-3 flex justify-between items-center border-t pt-3">
                        <!-- 수량 -->
                        <div class="flex items-center gap-2">
                          <div class="flex border rounded-full overflow-hidden">
                            <button type="button"
                                    class="decrease-btn w-8 h-8 flex items-center justify-center border-r text-gray-600 hover:bg-gray-100">
                              −
                            </button>
                            <input type="number"
                                  name="quantity_{{ item.id }}"
                                  value="{{ item.quantity }}"
                                  min="1"
                                  class="w-12 text-center text-sm outline-none">
                            <button type="button"
                                    class="increase-btn w-8 h-8 flex items-center justify-center border-l text-gray-600 hover:bg-gray-100">
                              ＋
                            </button>
                          </div>
                        </div>

                        <!-- 가격 + 삭제 -->
                        <div class="text-right">
                          <p class="font-semibold text-gray-800 item-total text-sm sm:text-base">
                            {{ ((item.product.base_price + (item.variant.price if item.variant and item.variant.price else 0)) * item.quantity) | int | format }}원
                          </p>
                          <button type="button"
                                  class="remove-btn text-red-500 text-xs hover:text-red-700 mt-1"
                                  data-url="{{ url_for('remove_from_cart', item_id=item.id) }}">
                            삭제
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                {% endfor %}
            {% else %}
                <p class="text-gray-500">{{ _("장바구니가 비어 있습니다") }}.</p>
            {% endif %}
        </div>

        <!-- 구매자 정보 -->
        <div class="bg-white shadow rounded p-4 sm:p-6 mb-24">
            <h2 class="text-lg sm:text-xl font-semibold mb-4">{{ _("구매자 정보") }}</h2>

            <div class="mb-4">
                <label class="block font-semibold mb-2">{{ _("이름") }}</label>
                <input type="text" name="name"
                       value="{{ user_info.name if user_info else '' }}"
                       required class="w-full border p-2 rounded text-sm sm:text-base">
            </div>

            <div class="mb-4">
                <label class="block font-semibold mb-2">{{ _("전화번호") }}</label>
                <input type="text" name="phone"
                       value="{{ user_info.phone if user_info else '' }}"
                       required class="w-full border p-2 rounded text-sm sm:text-base">
            </div>

            <div class="mb-4">
              <label class="block font-medium">{{ _("기본 주소") }}</label>
              <input type="text" name="address" value="{{ user_info.base_address if user_info else '' }}" 
                     class="w-full border rounded p-2 text-sm sm:text-base">
            </div>
            <div class="mb-4">
              <label class="block font-medium">{{ _("상세 주소") }}</label>
              <input type="text" name="detail_address" value="{{ user_info.detail_address if user_info else '' }}" 
                     class="w-full border rounded p-2 text-sm sm:text-base">
            </div>

            {% if not user_id %}
            <div class="mb-4">
              <label class="block font-semibold mb-2">{{ _("이메일") }}</label>
              <input type="email" name="email" placeholder="{{ _('이메일') }}" 
                     class="w-full border p-2 rounded text-sm sm:text-base" required>
            </div>
            {% endif %} 

            <div class="mb-4">
              <label class="block font-semibold mb-2">{{ _("쿠폰 선택") }}</label>
              <select id="coupon-select" name="user_coupon_id" class="w-full border p-2 rounded">
                <option value="">{{ _("쿠폰을 선택하세요") }}</option>
                {% for uc in available_coupons %}
                  <option value="{{ uc.id }}"
                          data-type="{{ uc.coupon.discount_type }}"
                          data-value="{{ uc.coupon.discount_value }}"
                          data-min="{{ uc.coupon.min_amount }}">
                    {{ uc.coupon.name }} - 
                    {% if uc.coupon.discount_type == "percent" %}
                      {{ uc.coupon.discount_value }}%
                    {% else %}
                      {{ uc.coupon.discount_value }}원
                    {% endif %}
                    ({{ uc.coupon.min_amount }}원 이상, {{ uc.coupon.valid_to.strftime('%Y-%m-%d') }}까지)
                  </option>
                {% endfor %}
              </select>
            </div>

            <!-- 하단 결제 바-->
            <div class="mb-4">
                <label class="block font-semibold mb-2">{{ _("결제 방법") }}</label>
                <select name="payment_method" id="payment-method" class="w-full border p-2 rounded text-sm sm:text-base">
                  <option value="무통장입금">{{ _("무통장입금") }}</option>
                  <option value="카드결제">{{ _("카드결제") }}</option>
                  <option value="카카오페이">{{ _("카카오페이") }}</option>
                  <option value="토스페이">{{ _("토스페이") }}</option>
                </select>
            </div>
        </div>

        <!-- 하단 고정 결제 바 -->
        <div class="fixed bottom-0 left-0 w-full bg-black border-t shadow-lg">
          <div class="max-w-5xl mx-auto flex flex-col sm:flex-row justify-between items-center gap-3 px-4 sm:px-6 py-3 text-sm sm:text-base">

            <!-- 가격 정보 -->
            <div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-6 w-full sm:w-auto text-center sm:text-left">
              <div class="text-gray-400 text-sm sm:text-base">
                {{ _("총 상품긍액") }}:
                <span id="total-price" class="font-semibold text-gray-200">0</span>{{ _("원") }}
              </div>
              <div class="text-gray-400 text-sm sm:text-base">
                {{ _("할인금액") }}:
                <span id="discount-price" class="font-semibold text-red-600">0</span>{{ _("원") }}
              </div>
              <div class="text-gray-400 text-sm sm:text-base">
                배송비:
                <span id="shipping-fee" class="font-semibold text-gray-200">0</span>원
              </div>
              <div class="text-gray-400 text-base sm:text-lg font-bold">
                {{ _("결제금액") }}:
                <span id="final-price" class="text-indigo-600 text-xl sm:text-2xl font-extrabold">0</span>원
              </div>
            </div>

            <!-- 결제 버튼 -->
            <button type="submit"
              class="w-full sm:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-bold text-base sm:text-xl px-4 sm:px-10 py-2 sm:py-3 rounded-lg shadow-md transition">
              {{ _("결제하기") }}
            </button>
          </div>
        </div>
    </form>
</div>

<script>
/* ✅ 전체선택 / 선택 삭제 */
document.getElementById("select-all")?.addEventListener("change", e => {
  const checked = e.target.checked;
  document.querySelectorAll(".item-checkbox").forEach(cb => cb.checked = checked);
  updateTotals();
  updateSelectedCount();
});

document.getElementById("delete-selected")?.addEventListener("click", async () => {
  const selected = [...document.querySelectorAll(".item-checkbox:checked")];
  if (selected.length === 0) {
    alert("삭제할 상품을 선택해주세요.");
    return;
  }

  if (!confirm(`선택된 ${selected.length}개의 상품을 삭제하시겠습니까?`)) return;

  for (const cb of selected) {
    const itemEl = cb.closest(".cart-item");
    const url = itemEl.querySelector(".remove-btn")?.dataset.url;
    if (url) {
      try {
        await fetch(url, {
          method: "POST",
          headers: { "X-Requested-With": "XMLHttpRequest" }
        });
      } catch {
        console.warn(`❌ 삭제 실패: ${url}`);
      }
    }
  }
  window.location.reload();
});

document.querySelectorAll(".item-checkbox").forEach(cb => 
  cb.addEventListener("change", updateSelectedCount)
);

function updateSelectedCount() {
  const selected = document.querySelectorAll(".item-checkbox:checked").length;
  document.getElementById("selected-count").innerText = selected;
}
</script>

<script>
document.getElementById("checkout-form").addEventListener("submit", async function(e) {
  e.preventDefault(); // ✅ 기본 제출 막기 (모든 케이스에서 먼저 막음)
  const form = e.target;
  const checked = document.querySelectorAll(".item-checkbox:checked");
  if (checked.length === 0) {
    alert("{{ _('결제할 상품을 선택해주세요.') }}");
    return;
  }

  // 결제 방식 확인
  const paymentMethod = document.getElementById("payment-method").value;

  // ✅ 무통장입금일 경우 → 서버로 바로 제출 (결제창 X)
  if (paymentMethod === "무통장입금") {
    if (confirm("{{ _('무통장입금으로 주문하시겠습니까?') }}")) {
      form.removeEventListener("submit", arguments.callee); // 이벤트 중복 방지
      form.submit(); // ✅ 기본 폼 제출로 서버 이동
    }
    return;
  }

  // ✅ 온라인 결제 (아임포트)
  try {
    // 1️⃣ 주문 생성
    const formData = new FormData(form);
    const resp = await fetch("/checkout", { method: "POST", body: formData });
    if (!resp.redirected) {
      alert("{{ _('주문 생성 중 오류가 발생했습니다.') }}");
      return;
    }
    // 2️⃣ 주문 생성 성공 → 결제 페이지로 이동
    window.location.href = resp.url;

  } catch (err) {
    console.error(err);
    alert("{{ _('결제 처리 중 오류가 발생했습니다.') }}");
    location.href = "/checkout";
  }
});
</script>

<script>
// ==============================
// 장바구니 합계 / 쿠폰 할인 계산
// ==============================
function updateTotals() {
  let total = 0;

  // 장바구니 상품 가격 합계
  document.querySelectorAll(".cart-item").forEach(item => {
    const checkbox = item.querySelector(".item-checkbox");
    const qtyInput = item.querySelector("input[type='number']");
    const qty = parseInt(qtyInput.value) || 1;
    const price = Number(item.dataset.price) || 0;

    // ✅ 옵션+수량 표시 부분 업데이트
    const optionQtySpan = item.querySelector(".option-qty-text");
    if (optionQtySpan) optionQtySpan.textContent = `${qty}개`;

    if (!checkbox.checked) return; // 체크된 상품만 합산
    total += qty * price;

    // 소계 표시
    item.querySelector(".item-total").textContent = (qty * price).toLocaleString() + "원";
  });

  // 쿠폰 적용
  let discount = 0;
  const select = document.getElementById("coupon-select");
  if (select) {
    const opt = select.options[select.selectedIndex];
    if (opt && opt.dataset.type) {
      const minAmount = parseInt(opt.dataset.min) || 0;
      if (total >= minAmount) {
        if (opt.dataset.type === "percent") {
          discount = Math.floor(total * (parseInt(opt.dataset.value) / 100));
        } else {
          discount = parseInt(opt.dataset.value);
        }
        if (discount > total) discount = total; // 음수 방지
      }
    }
  }

  // 배송비 계산 (5만원 이상 무료)
  const shipping = total >= 50000 ? 0 : (total > 0 ? 3000 : 0);

  // 최종 결제금액
  const final = total - discount + shipping;

  // DOM 반영
  document.getElementById("total-price").innerText = total.toLocaleString();
  document.getElementById("discount-price").innerText = discount.toLocaleString();
  document.getElementById("shipping-fee").innerText = shipping.toLocaleString();
  document.getElementById("final-price").innerText = final.toLocaleString();
}

// ==============================
// 수량 증감 버튼
// ==============================
document.querySelectorAll(".cart-item").forEach(item => {
  const decreaseBtn = item.querySelector(".decrease-btn");
  const increaseBtn = item.querySelector(".increase-btn");
  const quantityInput = item.querySelector("input[type='number']");

  decreaseBtn.addEventListener("click", () => {
    let val = parseInt(quantityInput.value) || 1;
    quantityInput.value = Math.max(1, val - 1);
    updateTotals();
  });

  increaseBtn.addEventListener("click", () => {
    let val = parseInt(quantityInput.value) || 1;
    quantityInput.value = val + 1;
    updateTotals();
  });

  quantityInput.addEventListener("input", updateTotals);
});

// ==============================
// 삭제 버튼 처리
// ==============================
document.querySelectorAll(".remove-btn").forEach(btn => {
  btn.addEventListener("click", function(e) {
    e.preventDefault();
    e.stopPropagation();
    const url = this.dataset.url;
    if (confirm("이 상품을 장바구니에서 삭제하시겠습니까?")) {
      fetch(url, {
        method: "POST",
        headers: { "X-Requested-With": "XMLHttpRequest" }
      })
      .then(res => res.ok ? window.location.reload() : alert("삭제 실패"))
      .catch(() => alert("서버 통신 오류가 발생했습니다."));
    }
  });
});

// ==============================
// 체크박스 선택 → 합계 갱신
// ==============================
document.querySelectorAll(".item-checkbox").forEach(cb => {
  cb.addEventListener("change", updateTotals);
});

// ==============================
// 쿠폰 선택 → 합계 갱신
// ==============================
const couponSelect = document.getElementById("coupon-select");
if (couponSelect) {
  couponSelect.addEventListener("change", updateTotals);
}

// ==============================
// 초기 실행
// ==============================
updateTotals();

</script>

<style>
/* ============================
   커스텀 체크박스 (동그라미 스타일)
   ============================ */
.custom-checkbox {
  display: inline-flex;
  align-items: center;
  cursor: pointer;
  position: relative;
}

.custom-checkbox input {
  display: none; /* 기본 체크박스 숨기기 */
}

.custom-checkbox .checkmark {
  width: 20px;
  height: 20px;
  border: 2px solid #ccc;
  border-radius: 50%; /* 동그라미 */
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
  position: relative;
}

/* 체크되었을 때 */
.custom-checkbox input:checked + .checkmark {
  border-color: #4f46e5; /* 인디고 */
  background-color: #4f46e5;
}

/* 체크 아이콘 */
.custom-checkbox .checkmark::after {
  content: "";
  width: 6px;
  height: 12px;
  border: solid white;
  border-width: 0 2px 2px 0;
  transform: rotate(45deg);
  opacity: 0;
  transition: opacity 0.2s ease;
}

.custom-checkbox input:checked + .checkmark::after {
  opacity: 1;
}

.cart-item {
  align-items: center;
}

.cart-item img {
  flex-shrink: 0;
}

.cart-item .item-total {
  min-width: 70px;
}
</style>

{% endblock %}
