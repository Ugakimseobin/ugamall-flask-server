{% extends "base.html" %}
{% block content %}
<div class="max-w-5xl mx-auto py-6 sm:py-10 px-4 sm:px-6">
  <!-- 상단 헤더 -->
  <div class="bg-white shadow rounded-lg p-4 sm:p-6 mb-6 flex flex-col items-start text-left">
    <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">{{ _("주문 / 결제") }}</h1>
    {% if cart_items %}
      <div class="text-sm sm:text-base text-gray-600 mt-2 sm:mt-0 pt-4">
        {{ _("총") }} <span id="cart-count" class="font-semibold text-indigo-600">{{ cart_items|length }}</span>{{ _("개 상품") }}
      </div>
    {% endif %}
  </div>

    <form method="post" id="checkout-form">
        <!-- 장바구니 -->
        <div class="bg-white shadow rounded p-4 sm:p-6 mb-8">
            {% if cart_items %}
                <div class="flex items-center justify-between mb-4 border-b pb-3">
                  <div class="flex items-center gap-4">
                    <label class="custom-checkbox flex-shrink-0 mr-2 sm:mr-4">
                      <input type="checkbox" id="select-all" class="all-checkbox">
                      <span class="checkmark"></span>
                       <p class="pl-2">{{ _("전체 선택") }}</p>
                    </label>
                    <button type="button" id="delete-selected" class="text-sm text-red-500 hover:text-red-700">
                      {{ _("선택 삭제") }}
                    </button>
                  </div>
                  <div class="text-gray-600 text-sm">
                    {{ _("선택된 상품") }}: <span id="selected-count" class="font-semibold text-indigo-600">0</span>{{ _("개") }}
                  </div>
                </div>
                {% for item in cart_items %}
                <div class="cart-item bg-white border rounded-lg shadow-sm p-4 mb-4 sm:flex sm:items-start sm:gap-5"
                      data-id="{{ item.id }}"
                      data-price="{{ item.product.base_price + (item.variant.price if item.variant and item.variant.price else 0) }}">
                    
                    <!-- 왼쪽 체크박스 -->
                    <div class="flex items-start sm:flex-col sm:items-center sm:pt-1">
                      <label class="custom-checkbox flex items-center sm:mb-2">
                        <input type="checkbox" name="selected_items" value="{{ item.id }}" class="item-checkbox">
                        <span class="checkmark ml-1"></span>
                      </label>
                    </div>

                    <!-- 중앙: 상품 이미지 -->
                    <div class="flex-shrink-0 w-full sm:w-32 h-40 sm:h-32 rounded-md overflow-hidden border">
                      <img src="{{ url_for('serve_product_image', product_id=item.product.id) }}"
                          alt="{{ item.product.name }}"
                          class="w-full h-full object-cover">
                    </div>

                    <!-- 우측 정보 -->
                    <div class="flex flex-col justify-between flex-1 mt-3 sm:mt-0 text-left">
                      <!-- 상단: 이름, 태그 -->
                      <div>
                        <div class="flex items-center gap-2 mb-1">
                          <span class="bg-green-100 text-green-700 text-xs font-medium px-2 py-0.5 rounded">{{ _("빠른배송") }}</span>
                        </div>
                        <p class="font-bold text-gray-900 text-base leading-snug">{{ _(item.product.name) }}</p>

                        <p class="text-gray-500 text-xs sm:text-sm mt-1">
                          {% if item.variant %}
                            {% for key, val in item.variant.options.items() %}
                              {{ _(key) }}: {{ _(val) }}{% if not loop.last %} / {% endif %}
                            {% endfor %}
                          {% else %}
                            기본상품
                          {% endif %}
                          / <span class="option-qty-text">{{ item.quantity }}{{ _("개") }}</span>
                        </p>
                      </div>

                      <!-- 중간: 가격 -->
                      <div class="mt-2">
                        <div class="flex items-center gap-2">
                          <span class="text-[#222] font-bold text-lg sm:text-xl">
                            {{ (item.product.base_price + (item.variant.price if item.variant and item.variant.price else 0)) | int | format }}{{ _("원") }}
                          </span>
                        </div>
                      </div>

                      <!-- 하단: 수량 조절 + 삭제 -->
                      <div class="mt-3 flex justify-between items-center border-t pt-3">
                        <!-- 수량 -->
                        <div class="flex items-center gap-2">
                          <div class="flex border rounded-full overflow-hidden">
                            <button type="button"
                                    class="decrease-btn w-8 h-8 flex items-center justify-center border-r text-gray-600 hover:bg-gray-100">
                              −
                            </button>
                            <input type="number"
                                  name="quantity_{{ item.id }}"
                                  value="{{ item.quantity }}"
                                  min="1"
                                  class="w-12 text-center text-sm outline-none">
                            <button type="button"
                                    class="increase-btn w-8 h-8 flex items-center justify-center border-l text-gray-600 hover:bg-gray-100">
                              ＋
                            </button>
                          </div>
                        </div>

                        <!-- 가격 + 삭제 -->
                        <div class="text-right">
                          <p class="font-semibold text-gray-800 item-total text-sm sm:text-base">
                            {{ ((item.product.base_price + (item.variant.price if item.variant and item.variant.price else 0)) * item.quantity) | int | format }}{{ _("원") }}
                          </p>
                          <button type="button"
                                  class="remove-btn text-red-500 text-xs hover:text-red-700 mt-1"
                                  data-url="{{ url_for('remove_from_cart', item_id=item.id) }}">
                            {{ _("삭제") }}
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                {% endfor %}
            {% else %}
                <p class="text-gray-500">{{ _("장바구니가 비어 있습니다") }}.</p>
            {% endif %}
        </div>

        <!-- 구매자 정보 -->
        <div class="bg-white shadow rounded p-4 sm:p-6 mb-24">
            <h2 class="text-lg sm:text-xl font-semibold mb-4">{{ _("구매자 정보") }}</h2>

            <div class="mb-4">
                <label class="block font-semibold mb-2">{{ _("이름") }}</label>
                <input type="text" name="name"
                       value="{{ user_info.name if user_info else '' }}"
                       required class="w-full border p-2 rounded text-sm sm:text-base">
            </div>

            <div class="mb-4">
                <label class="block font-semibold mb-2">{{ _("전화번호") }}</label>
                <input type="text" name="phone"
                       value="{{ user_info.phone if user_info else '' }}"
                       required class="w-full border p-2 rounded text-sm sm:text-base">
            </div>

            <div class="mb-4">
              <label class="block font-semibold mb-2">{{ _("주소") }}</label>
              <div class="flex gap-2 mb-2">
                <input type="text" id="address" name="address" placeholder="{{ _('기본 주소') }}"
                      value="{{ user_info.base_address if user_info else '' }}"
                      class="border p-2 rounded w-1/2 bg-gray-100" readonly>
                <button type="button" onclick="execDaumPostcode()"
                        class="px-3 py-2 bg-white border border-gray-400 rounded hover:bg-gray-100 active:scale-[0.97] transition">
                  {{ _("주소 찾기") }}
                </button>
              </div>
              <input type="text" id="detailAddress" name="detail_address"
                    value="{{ user_info.detail_address if user_info else '' }}"
                    placeholder="{{ _('상세 주소') }}"
                    class="w-full border rounded p-2 text-sm sm:text-base">
            </div>

            <!-- ✅ 비회원 이메일 인증 -->
            {% if not user_id %}
            <div class="mb-4">
              <label class="block font-semibold mb-2">{{ _("이메일") }}</label>

              <!-- 이메일 입력 + 인증메일 전송 -->
              <div class="flex space-x-2 mb-2">
                <input type="email" id="guest_email" name="email"
                      placeholder="{{ _('이메일 입력') }}"
                      required
                      class="flex-1 border rounded p-2 focus:ring-2 focus:ring-indigo-300 focus:border-indigo-400 transition">
                <button type="button" id="send-email-btn" onclick="sendGuestEmailCode()"
                        class="bg-white border border-gray-400 text-[#222] px-3 py-2 rounded hover:bg-gray-50 active:scale-[0.97] transition">
                  {{ _("인증메일 보내기") }}
                </button>
              </div>

              <!-- 인증코드 입력 -->
              <div class="flex space-x-2">
                <input type="text" id="guest_verify_code"
                      placeholder="{{ _('인증코드 입력') }}"
                      class="border rounded p-2 flex-1 focus:ring-2 focus:ring-green-300 focus:border-green-400 transition">
                <button type="button" id="verify-email-btn" onclick="verifyGuestEmailCode()"
                        class="bg-green-600 text-white px-3 py-2 rounded hover:bg-green-700 active:scale-[0.97] transition">
                  {{ _("인증 확인") }}
                </button>
              </div>
              <p id="guest-email-status" class="text-xs text-gray-500 mt-1"></p>
            </div>
            {% endif %}

            <div class="mb-4">
              <label class="block font-semibold mb-2">{{ _("쿠폰 선택") }}</label>
              <select id="coupon-select" name="user_coupon_id" class="w-full border p-2 rounded">
                <option value="">{{ _("쿠폰을 선택하세요") }}</option>
                {% for uc in available_coupons %}
                  <option value="{{ uc.id }}"
                          data-type="{{ uc.coupon.discount_type }}"
                          data-value="{{ uc.coupon.discount_value }}"
                          data-min="{{ uc.coupon.min_amount }}">
                    {{ _(uc.coupon.name) }} - 
                    {% if uc.coupon.discount_type == "percent" %}
                      {{ uc.coupon.discount_value }}%
                    {% else %}
                      {{ uc.coupon.discount_value }}원
                    {% endif %}
                    ({{ uc.coupon.min_amount }}원 이상, {{ uc.coupon.valid_to.strftime('%Y-%m-%d') }}까지)
                  </option>
                {% endfor %}
              </select>
            </div>

            <!-- 하단 결제 바-->
            <div class="mb-4">
                <label class="block font-semibold mb-2">{{ _("결제 방법") }}</label>
                <select name="payment_method" id="payment-method" class="w-full border p-2 rounded text-sm sm:text-base">
                  <option value="무통장입금">{{ _("무통장입금") }}</option>
                  <option value="카드결제">{{ _("카드결제") }}</option>
                  <option value="카카오페이">{{ _("카카오페이") }}</option>
                  <option value="토스페이">{{ _("토스페이") }}</option>
                </select>
            </div>
        </div>

        <!-- 하단 고정 결제 바 -->
        <div class="fixed bottom-0 left-0 w-full bg-black border-t shadow-lg">
          <div class="max-w-5xl mx-auto flex flex-col sm:flex-row justify-between items-center gap-3 px-4 sm:px-6 py-3 text-sm sm:text-base">

            <!-- 가격 정보 -->
            <div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-6 w-full sm:w-auto text-center sm:text-left">
              <div class="text-gray-400 text-sm sm:text-base">
                {{ _("총 상품금액") }}:
                <span id="total-price" class="font-semibold text-gray-200">0</span>{{ _("원") }}
              </div>
              <div class="text-gray-400 text-sm sm:text-base">
                {{ _("할인금액") }}:
                <span id="discount-price" class="font-semibold text-red-600">0</span>{{ _("원") }}
              </div>
              <div class="text-gray-400 text-sm sm:text-base">
                {{ _("배송비") }}:
                <span id="shipping-fee" class="font-semibold text-gray-200">0</span>{{ _("원") }}
              </div>
              <div class="text-gray-400 text-base sm:text-lg mb-2 font-bold">
                {{ _("결제금액") }}:
                <span id="final-price" class="text-indigo-600 text-xl sm:text-2xl font-extrabold">0</span>{{ _("원") }}
              </div>
            </div>

            <!-- 결제 버튼 -->
            <button type="submit"
              class="w-full sm:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-bold text-base sm:text-xl px-4 sm:px-10 py-2 sm:py-3 rounded-lg shadow-md transition">
              {{ _("결제하기") }}
            </button>
          </div>
        </div>
    </form>
</div>

<script>
/* ✅ 전체선택 / 선택 삭제 */
document.getElementById("select-all")?.addEventListener("change", e => {
  const checked = e.target.checked;
  document.querySelectorAll(".item-checkbox").forEach(cb => cb.checked = checked);
  updateTotals();
  updateSelectedCount();
});

document.getElementById("delete-selected")?.addEventListener("click", async () => {
  const selected = [...document.querySelectorAll(".item-checkbox:checked")];
  if (selected.length === 0) {
    alert("{{ _('삭제할 상품을 선택해주세요') }}.");
    return;
  }

  if (!confirm(`{{ _("선택된 ${selected.length}개의 상품을 삭제하시겠습니까") }}`)) return;

  for (const cb of selected) {
    const itemEl = cb.closest(".cart-item");
    const url = itemEl.querySelector(".remove-btn")?.dataset.url;
    if (url) {
      try {
        await fetch(url, {
          method: "POST",
          headers: { "X-Requested-With": "XMLHttpRequest" }
        });
      } catch {
        console.warn(`❌ 삭제 실패: ${url}`);
      }
    }
  }
  window.location.reload();
});

document.querySelectorAll(".item-checkbox").forEach(cb => 
  cb.addEventListener("change", updateSelectedCount)
);

function updateSelectedCount() {
  const selected = document.querySelectorAll(".item-checkbox:checked").length;
  document.getElementById("selected-count").innerText = selected;
}
</script>

<script>
document.getElementById("checkout-form").addEventListener("submit", async function(e) {
  e.preventDefault(); // ✅ 기본 제출 막기 (모든 케이스에서 먼저 막음)
  const form = e.target;
  const checked = document.querySelectorAll(".item-checkbox:checked");
  if (checked.length === 0) {
    alert("{{ _('결제할 상품을 선택해주세요.') }}");
    return;
  }

  // 결제 방식 확인
  const paymentMethod = document.getElementById("payment-method").value;

  // ✅ 무통장입금일 경우 → 서버로 바로 제출 (결제창 X)
  if (paymentMethod === "무통장입금") {
    if (confirm("{{ _('무통장입금으로 주문하시겠습니까?') }}")) {
      form.removeEventListener("submit", arguments.callee); // 이벤트 중복 방지
      form.submit(); // ✅ 기본 폼 제출로 서버 이동
    }
    return;
  }

  // ✅ 온라인 결제 (아임포트)
  try {
    // 1️⃣ 주문 생성
    const formData = new FormData(form);
    const resp = await fetch("/checkout", { method: "POST", body: formData });
    if (!resp.redirected) {
      alert("{{ _('주문 생성 중 오류가 발생했습니다.') }}");
      return;
    }
    // 2️⃣ 주문 생성 성공 → 결제 페이지로 이동
    window.location.href = resp.url;

  } catch (err) {
    console.error(err);
    alert("{{ _('결제 처리 중 오류가 발생했습니다.') }}");
    location.href = "/checkout";
  }
});
</script>

<script>
// ==============================
// 장바구니 합계 / 쿠폰 할인 계산
// ==============================
function updateTotals() {
  let total = 0;

  // 장바구니 상품 가격 합계
  document.querySelectorAll(".cart-item").forEach(item => {
    const checkbox = item.querySelector(".item-checkbox");
    const qtyInput = item.querySelector("input[type='number']");
    const qty = parseInt(qtyInput.value) || 1;
    const price = Number(item.dataset.price) || 0;

    // ✅ 옵션+수량 표시 부분 업데이트
    const optionQtySpan = item.querySelector(".option-qty-text");
    if (optionQtySpan) optionQtySpan.textContent = `${qty}개`;

    if (!checkbox.checked) return; // 체크된 상품만 합산
    total += qty * price;

    // 소계 표시
    item.querySelector(".item-total").textContent = (qty * price).toLocaleString() + "원";
  });

  // 쿠폰 적용
  let discount = 0;
  const select = document.getElementById("coupon-select");
  if (select) {
    const opt = select.options[select.selectedIndex];
    if (opt && opt.dataset.type) {
      const minAmount = parseInt(opt.dataset.min) || 0;
      if (total >= minAmount) {
        if (opt.dataset.type === "percent") {
          discount = Math.floor(total * (parseInt(opt.dataset.value) / 100));
        } else {
          discount = parseInt(opt.dataset.value);
        }
        if (discount > total) discount = total; // 음수 방지
      }
    }
  }

  // 배송비 계산 (5만원 이상 무료)
  const shipping = total >= 50000 ? 0 : (total > 0 ? 3000 : 0);

  // 최종 결제금액
  const final = total - discount + shipping;

  // DOM 반영
  document.getElementById("total-price").innerText = total.toLocaleString();
  document.getElementById("discount-price").innerText = discount.toLocaleString();
  document.getElementById("shipping-fee").innerText = shipping.toLocaleString();
  document.getElementById("final-price").innerText = final.toLocaleString();
}

// ==============================
// 수량 증감 버튼
// ==============================
document.querySelectorAll(".cart-item").forEach(item => {
  const decreaseBtn = item.querySelector(".decrease-btn");
  const increaseBtn = item.querySelector(".increase-btn");
  const quantityInput = item.querySelector("input[type='number']");

  decreaseBtn.addEventListener("click", () => {
    let val = parseInt(quantityInput.value) || 1;
    quantityInput.value = Math.max(1, val - 1);
    updateTotals();
  });

  increaseBtn.addEventListener("click", () => {
    let val = parseInt(quantityInput.value) || 1;
    quantityInput.value = val + 1;
    updateTotals();
  });

  quantityInput.addEventListener("input", updateTotals);
});

// ==============================
// 삭제 버튼 처리
// ==============================
document.querySelectorAll(".remove-btn").forEach(btn => {
  btn.addEventListener("click", function(e) {
    e.preventDefault();
    e.stopPropagation();
    const url = this.dataset.url;
    if (confirm("{{ _('이 상품을 장바구니에서 삭제하시겠습니까') }}?")) {
      fetch(url, {
        method: "POST",
        headers: { "X-Requested-With": "XMLHttpRequest" }
      })
      .then(res => res.ok ? window.location.reload() : alert("삭제 실패"))
      .catch(() => alert("서버 통신 오류가 발생했습니다."));
    }
  });
});

// ==============================
// 체크박스 선택 → 합계 갱신
// ==============================
document.querySelectorAll(".item-checkbox").forEach(cb => {
  cb.addEventListener("change", updateTotals);
});

// ==============================
// 쿠폰 선택 → 합계 갱신
// ==============================
const couponSelect = document.getElementById("coupon-select");
if (couponSelect) {
  couponSelect.addEventListener("change", updateTotals);
}

// ==============================
// 초기 실행
// ==============================
updateTotals();

</script>

<script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script>
function execDaumPostcode() {
  new daum.Postcode({
    oncomplete: function(data) {
      const fullAddress = data.roadAddress || data.jibunAddress;
      const postcode = data.zonecode;

      // ✅ 우편번호 입력칸이 있을 경우만 넣기 (안 만들어도 오류 안 남)
      const postcodeInput = document.getElementById("postcode");
      if (postcodeInput) postcodeInput.value = postcode;

      // ✅ 기본 주소 입력
      const addressInput = document.getElementById("address");
      if (addressInput) addressInput.value = fullAddress;

      // ✅ 상세주소 포커스 이동
      const detailInput = document.getElementById("detailAddress");
      if (detailInput) detailInput.focus();
    }
  }).open();
}
</script>

<!-- ✅ 이메일 인증 JS -->
<script>
let guestVerified = {{ 'true' if user_id else 'false' }}; // 회원은 이미 인증된 상태로 처리

function sendGuestEmailCode() {
  const email = document.getElementById("guest_email").value.trim();
  const btn = document.getElementById("send-email-btn");
  const statusEl = document.getElementById("guest-email-status");

  if (!email) return alert("{{ _('이메일을 입력해주세요') }}.");

  btn.disabled = true;
  btn.innerHTML = `<span>{{ _("전송 중") }}...</span><div class='loading-spinner'></div>`;

  fetch("/send_email_code", {
    method: "POST",
    body: new URLSearchParams({ email })
  })
  .then(res => res.json())
  .then(data => {
    alert(data.message);
    statusEl.textContent = "{{ _('인증메일이 발송되었습니다. 메일함을 확인해주세요') }}.";
    statusEl.className = "text-xs text-green-600 mt-1";
  })
  .catch(err => {
    alert("이메일 전송 중 오류가 발생했습니다.");
    console.error(err);
  })
  .finally(() => {
    btn.disabled = false;
    btn.innerHTML = "인증메일 보내기";
  });
}

function verifyGuestEmailCode() {
  const code = document.getElementById("guest_verify_code").value.trim();
  const statusEl = document.getElementById("guest-email-status");

  if (!code) return alert("{{ _('인증코드를 입력해주세요') }}.");

  fetch("/verify_email_code", {
    method: "POST",
    body: new URLSearchParams({ code })
  })
  .then(res => res.json())
  .then(data => {
    alert(data.message);
    if (data.message.includes("완료")) {
      guestVerified = true;
      statusEl.textContent = "{{ _('이메일 인증이 완료되었습니다') }}.";
      statusEl.className = "text-xs text-green-600 mt-1 font-semibold";
    } else {
      guestVerified = false;
      statusEl.textContent = "{{ _('인증에 실패했습니다. 다시 시도해주세요') }}.";
      statusEl.className = "text-xs text-red-500 mt-1";
    }
  })
  .catch(err => {
    console.error(err);
    alert("서버 오류가 발생했습니다.");
  });
}

// ✅ 결제 전 인증 확인
document.getElementById("checkout-form").addEventListener("submit", function(e) {
  const paymentMethod = document.getElementById("payment-method").value;
  if (!guestVerified && paymentMethod !== "무통장입금") {
    e.preventDefault();
    alert("비회원 주문은 이메일 인증 후 결제 가능합니다.");
    return false;
  }
});
</script>

<style>
.loading-spinner {
  border: 2px solid #f3f3f3;
  border-top: 2px solid #4f46e5;
  border-radius: 50%;
  width: 16px;
  height: 16px;
  animation: spin 0.8s linear infinite;
  display: inline-block;
  vertical-align: middle;
  margin-left: 6px;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>

<style>
/* ============================
   커스텀 체크박스 (동그라미 스타일)
   ============================ */
.custom-checkbox {
  display: inline-flex;
  align-items: center;
  cursor: pointer;
  position: relative;
}

.custom-checkbox input {
  display: none; /* 기본 체크박스 숨기기 */
}

.custom-checkbox .checkmark {
  width: 20px;
  height: 20px;
  border: 2px solid #ccc;
  border-radius: 50%; /* 동그라미 */
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
  position: relative;
}

/* 체크되었을 때 */
.custom-checkbox input:checked + .checkmark {
  border-color: #4f46e5; /* 인디고 */
  background-color: #4f46e5;
}

/* 체크 아이콘 */
.custom-checkbox .checkmark::after {
  content: "";
  width: 6px;
  height: 12px;
  border: solid white;
  border-width: 0 2px 2px 0;
  transform: rotate(45deg);
  opacity: 0;
  transition: opacity 0.2s ease;
}

.custom-checkbox input:checked + .checkmark::after {
  opacity: 1;
}

.cart-item {
  align-items: center;
}

.cart-item img {
  flex-shrink: 0;
}

.cart-item .item-total {
  min-width: 70px;
}
</style>

{% endblock %}
