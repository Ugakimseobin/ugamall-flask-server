{% extends "base.html" %}
{% block content %}
<div class="max-w-5xl mx-auto py-6 sm:py-10 px-4 sm:px-6">
    <h1 class="text-2xl sm:text-3xl font-bold mb-6">{{ _("주문 / 결제") }}</h1>

    <form method="post" id="checkout-form">
        <!-- 장바구니 -->
        <div class="bg-white shadow rounded p-4 sm:p-6 mb-8">
            {% if cart_items %}
                {% for item in cart_items %}
                <div class="cart-item flex flex-col sm:flex-row sm:items-center border-b py-4 gap-4 sm:gap-0"
                     data-id="{{ item.id }}"
                     data-price="{{ item.product.base_price + (item.variant.price if item.variant and item.variant.price else 0) }}">

                    <!-- 체크박스 -->
                    <label class="custom-checkbox flex-shrink-0 mr-2 sm:mr-4">
                        <input type="checkbox" name="selected_items" value="{{ item.id }}" class="item-checkbox">
                        <span class="checkmark"></span>
                    </label>

                    <!-- 제품 이미지 -->
                    <img src="{{ url_for('static', filename='images/' ~ item.variant.product.image) }}" 
                         alt="{{ item.variant.product.name }}" 
                         class="w-20 h-20 object-cover rounded sm:mr-4">

                    <!-- 중앙: 제품명 + 옵션 -->
                    <div class="flex-1">
                        <p class="font-bold text-sm sm:text-base">{{ item.variant.product.name }}</p>
                        <p class="text-gray-500 text-xs sm:text-sm">
                            {% if item.variant %}
                                {% for key, val in item.variant.options.items() %}
                                    {{ key }}: {{ val }}
                                {% endfor %}
                            {% else %}
                                {{ _("기본상품") }}
                            {% endif %}
                        </p>
                    </div>

                    <!-- 수량 조절 -->
                    <div class="flex items-center mt-2 sm:mt-0">
                        <button type="button" class="px-2 py-1 bg-gray-200 rounded-l decrease-btn">-</button>
                        <input type="number" name="quantity_{{ item.id }}" value="{{ item.quantity }}" min="1"
                               class="w-12 sm:w-16 text-center border-t border-b text-xs sm:text-sm">
                        <button type="button" class="px-2 py-1 bg-gray-200 rounded-r increase-btn">+</button>
                    </div>

                    <!-- 우측: 가격 + 삭제 -->
                    <div class="w-full sm:w-32 text-right mt-2 sm:mt-0">
                        <div class="font-semibold item-total text-sm sm:text-base">
                            {{ (item.product.base_price + (item.variant.price if item.variant and item.variant.price else 0)) * item.quantity }}{{ _("원") }}
                        </div>
                        <button type="button" class="remove-btn mt-1 sm:mt-2 text-red-500 hover:text-red-700 text-xs sm:text-sm"
                                data-url="{{ url_for('remove_from_cart', item_id=item.id) }}">
                            {{ _("삭제") }}
                        </button>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <p class="text-gray-500">{{ _("장바구니가 비어 있습니다") }}.</p>
            {% endif %}
        </div>

        <!-- 구매자 정보 -->
        <div class="bg-white shadow rounded p-4 sm:p-6 mb-24">
            <h2 class="text-lg sm:text-xl font-semibold mb-4">{{ _("구매자 정보") }}</h2>

            <div class="mb-4">
                <label class="block font-semibold mb-2">{{ _("이름") }}</label>
                <input type="text" name="name"
                       value="{{ user_info.name if user_info else '' }}"
                       required class="w-full border p-2 rounded text-sm sm:text-base">
            </div>

            <div class="mb-4">
                <label class="block font-semibold mb-2">{{ _("전화번호") }}</label>
                <input type="text" name="phone"
                       value="{{ user_info.phone if user_info else '' }}"
                       required class="w-full border p-2 rounded text-sm sm:text-base">
            </div>

            <div class="mb-4">
              <label class="block font-medium">{{ _("기본 주소") }}</label>
              <input type="text" name="address" value="{{ user_info.base_address if user_info else '' }}" 
                     class="w-full border rounded p-2 text-sm sm:text-base">
            </div>
            <div class="mb-4">
              <label class="block font-medium">{{ _("상세 주소") }}</label>
              <input type="text" name="detail_address" value="{{ user_info.detail_address if user_info else '' }}" 
                     class="w-full border rounded p-2 text-sm sm:text-base">
            </div>

            {% if not user_id %}
            <div class="mb-4">
              <label class="block font-semibold mb-2">{{ _("이메일") }}</label>
              <input type="email" name="email" placeholder="{{ _('이메일') }}" 
                     class="w-full border p-2 rounded text-sm sm:text-base" required>
            </div>
            {% endif %} 

            <div class="mb-4">
              <label class="block font-semibold mb-2">{{ _("쿠폰 선택") }}</label>
              <select id="coupon-select" name="user_coupon_id" class="w-full border p-2 rounded">
                <option value="">{{ _("쿠폰을 선택하세요") }}</option>
                {% for uc in available_coupons %}
                  <option value="{{ uc.id }}"
                          data-type="{{ uc.coupon.discount_type }}"
                          data-value="{{ uc.coupon.discount_value }}"
                          data-min="{{ uc.coupon.min_amount }}">
                    {{ uc.coupon.name }} - 
                    {% if uc.coupon.discount_type == "percent" %}
                      {{ uc.coupon.discount_value }}%
                    {% else %}
                      {{ uc.coupon.discount_value }}원
                    {% endif %}
                    ({{ uc.coupon.min_amount }}원 이상, {{ uc.coupon.valid_to.strftime('%Y-%m-%d') }}까지)
                  </option>
                {% endfor %}
              </select>
            </div>

            <!-- 하단 결제 바-->
            <div class="mb-4">
                <label class="block font-semibold mb-2">{{ _("결제 방법") }}</label>
                <select name="payment_method" class="w-full border p-2 rounded text-sm sm:text-base">
                    <option value="무통장입금">{{ _("무통장입금") }}</option>
                    <option value="카드결제">{{ _("카드결제") }}</option>
                    <option value="간편결제">{{ _("간편결제") }}</option>
                </select>
            </div>
        </div>

        <!-- 하단 고정 결제 바 -->
        <div class="fixed bottom-0 left-0 w-full bg-white border-t shadow-lg">
          <div class="max-w-5xl mx-auto flex flex-col sm:flex-row justify-between items-center gap-3 px-4 sm:px-6 py-3">

            <!-- 가격 정보 -->
            <div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-6 w-full sm:w-auto text-center sm:text-left">
              <div class="text-gray-600 text-sm sm:text-base">
                총 상품금액:
                <span id="total-price" class="font-semibold text-gray-900">0</span>원
              </div>
              <div class="text-gray-600 text-sm sm:text-base">
                할인금액:
                <span id="discount-price" class="font-semibold text-red-600">0</span>원
              </div>
              <div class="text-gray-900 text-base sm:text-lg font-bold">
                결제금액:
                <span id="final-price" class="text-indigo-600 text-xl sm:text-2xl font-extrabold">0</span>원
              </div>
            </div>

            <!-- 결제 버튼 -->
            <button type="submit"
              class="w-full sm:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-bold text-lg sm:text-xl px-6 sm:px-10 py-3 rounded-lg shadow-md transition">
              결제하기
            </button>
          </div>
        </div>
    </form>
</div>

<script>
// ==============================
// 장바구니 합계 / 쿠폰 할인 계산
// ==============================
function updateTotals() {
  let total = 0;

  // 장바구니 상품 가격 합계
  document.querySelectorAll(".cart-item").forEach(item => {
    const checkbox = item.querySelector(".item-checkbox");
    if (!checkbox.checked) return;   // 체크된 상품만 합산

    const qty = parseInt(item.querySelector("input[type='number']").value) || 1;
    const price = Number(item.dataset.price) || 0;
    total += qty * price;

    // 소계 표시
    item.querySelector(".item-total").textContent = (qty * price).toLocaleString() + "원";
  });

  // 쿠폰 적용
  let discount = 0;
  const select = document.getElementById("coupon-select");
  if (select) {
    const opt = select.options[select.selectedIndex];
    if (opt && opt.dataset.type) {
      const minAmount = parseInt(opt.dataset.min) || 0;
      if (total >= minAmount) {
        if (opt.dataset.type === "percent") {
          discount = Math.floor(total * (parseInt(opt.dataset.value) / 100));
        } else {
          discount = parseInt(opt.dataset.value);
        }
        if (discount > total) discount = total; // 음수 방지
      }
    }
  }

  // DOM 반영
  document.getElementById("total-price").innerText = total.toLocaleString();
  document.getElementById("discount-price").innerText = discount.toLocaleString();
  document.getElementById("final-price").innerText = (total - discount).toLocaleString();
}

// ==============================
// 수량 증감 버튼
// ==============================
document.querySelectorAll(".cart-item").forEach(item => {
  const decreaseBtn = item.querySelector(".decrease-btn");
  const increaseBtn = item.querySelector(".increase-btn");
  const quantityInput = item.querySelector("input[type='number']");

  decreaseBtn.addEventListener("click", () => {
    let val = parseInt(quantityInput.value) || 1;
    quantityInput.value = Math.max(1, val - 1);
    updateTotals();
  });

  increaseBtn.addEventListener("click", () => {
    let val = parseInt(quantityInput.value) || 1;
    quantityInput.value = val + 1;
    updateTotals();
  });

  quantityInput.addEventListener("input", updateTotals);
});

// ==============================
// 체크박스 선택 → 합계 갱신
// ==============================
document.querySelectorAll(".item-checkbox").forEach(cb => {
  cb.addEventListener("change", updateTotals);
});

// ==============================
// 쿠폰 선택 → 합계 갱신
// ==============================
const couponSelect = document.getElementById("coupon-select");
if (couponSelect) {
  couponSelect.addEventListener("change", updateTotals);
}

// ==============================
// 초기 실행
// ==============================
updateTotals();

// ==============================
// 결제 버튼 눌렀을 때 체크 확인
// ==============================
document.getElementById("checkout-form").addEventListener("submit", function(e) {
  const checked = document.querySelectorAll(".item-checkbox:checked");
  if (checked.length === 0) {
    e.preventDefault();
    alert("결제할 상품을 선택해주세요.");
  }
});
</script>

<style>
/* ============================
   커스텀 체크박스 (동그라미 스타일)
   ============================ */
.custom-checkbox {
  display: inline-flex;
  align-items: center;
  cursor: pointer;
  position: relative;
}

.custom-checkbox input {
  display: none; /* 기본 체크박스 숨기기 */
}

.custom-checkbox .checkmark {
  width: 20px;
  height: 20px;
  border: 2px solid #ccc;
  border-radius: 50%; /* 동그라미 */
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
  position: relative;
}

/* 체크되었을 때 */
.custom-checkbox input:checked + .checkmark {
  border-color: #4f46e5; /* 인디고 */
  background-color: #4f46e5;
}

/* 체크 아이콘 */
.custom-checkbox .checkmark::after {
  content: "";
  width: 6px;
  height: 12px;
  border: solid white;
  border-width: 0 2px 2px 0;
  transform: rotate(45deg);
  opacity: 0;
  transition: opacity 0.2s ease;
}

.custom-checkbox input:checked + .checkmark::after {
  opacity: 1;
}
</style>
{% endblock %}
