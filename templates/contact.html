{% extends "base.html" %}
{% block content %}
<!-- 상단 비디오 배경 -->
<section id="hero" class="relative h-80 md:h-[28rem] flex items-center justify-center text-white overflow-hidden">
  <!--<video autoplay muted loop playsinline 
         class="absolute inset-0 w-full h-full object-cover object-bottom">
    <source src="{{ url_for('static', filename='videos/ocean.mp4') }}" type="video/mp4">
  </video>-->
  <img src="{{ url_for('static', filename='images/xcontact.jpg') }}" class="absolute inset-0 w-full h-full object-cover">
  <div class="absolute inset-0 bg-black/40"></div>
  <h1 class="relative z-10 text-2xl sm:text-3xl font-bold" style="font-family: 'TheJamsil5Bold', 'Noto Sans KR', sans-serif; font-weight:700;">{{ _("유가에 문의하기") }}</h1>
</section>

<!-- 문의하기 폼 -->
<div class="max-w-3xl mx-auto py-8 sm:py-12 px-4">
  <h2 class="text-xl sm:text-2xl font-bold mb-6">{{ _("문의하기") }}</h2>

  <form method="POST" class="space-y-4 bg-white p-4 sm:p-6 shadow rounded">
    {% if not current_user.is_authenticated %}
      <!-- ✅ 비회원 이메일 인증 -->
      <div>
        <label class="block text-sm font-semibold mb-1">{{ _("이메일") }}</label>
        <div class="flex space-x-2 mb-2">
          <input type="email" id="contact_email" name="email" value="{{ email or '' }}"
                 class="w-full border border-gray-300 rounded-lg p-2.5 flex-1 focus:ring-2 focus:ring-[#007AFF]"
                 placeholder="{{ _('이메일 입력') }}" required>
          <button type="button" id="send-email-btn" onclick="sendEmailCodeContact()"
                  class="bg-white border border-gray-400 text-[#222] px-3 py-2 rounded-lg hover:bg-gray-100 active:scale-[0.97] transition">
            {{ _("인증메일 보내기") }}
          </button>
        </div>

        <div class="flex space-x-2 mb-1">
          <input type="text" id="verify_email_code" placeholder="{{ _('인증코드 입력') }}"
                 class="border border-gray-300 p-2 rounded-lg flex-1 focus:ring-2 focus:ring-green-300 focus:border-green-400 transition">
          <button type="button" onclick="verifyEmailCodeContact()"
                  class="bg-green-600 text-white px-3 py-2 rounded-lg hover:bg-green-700 active:scale-[0.97] transition">
            {{ _("인증 확인") }}
          </button>
        </div>
        <p id="email-status" class="text-xs text-gray-500 mt-1"></p>
      </div>

      <div>
        <label class="block text-sm font-semibold mb-1">{{ _("이름") }}</label>
        <input type="text" name="guest_name" value="{{ guest_name or '' }}" class="w-full border border-gray-300 rounded-lg p-2.5">
      </div>

      <div>
        <label class="block text-sm font-semibold mb-1">{{ _("전화번호") }}</label>
        <input type="text" name="guest_phone" value="{{ guest_phone or '' }}" class="w-full border border-gray-300 rounded-lg p-2.5">
      </div>
    {% endif %}

    <div>
      <label class="block font-semibold mb-1 text-sm sm:text-base">{{ _("제목") }}</label>
      <input type="text" name="title" value="{{ title or '' }}" required
             class="w-full border rounded p-2 text-sm sm:text-base"
             placeholder="{{ _('문의 제목') }}">
    </div>

    <div>
      <label class="block font-semibold mb-1 text-sm sm:text-base">{{ _("내용") }}</label>
      <textarea name="content" rows="5" required
                class="w-full border rounded p-2 text-sm sm:text-base"
                placeholder="{{ _('문의 내용을 입력하세요') }}">{{ content or '' }}</textarea>
    </div>

    <button type="submit" class="btn-dark text-white px-4 sm:px-6 py-2 rounded hover:opacity-90 text-sm sm:text-base">
      {{ _("보내기") }}
    </button>
    <div class="g-recaptcha" 
        data-sitekey="6LfOVQAsAAAAAAGSTK6ge0BoGeT6OGpuQG7-jPf3"
        data-theme="light"
        style="transform:scale(0.95); transform-origin:0 0;">
    </div>
  </form>

  <!-- 회사 위치 -->
  <div class="mt-12 sm:mt-16">
    <h2 class="text-2xl sm:text-3xl font-bold mb-6">{{ _("오시는 길") }}</h2>
    <div class="bg-white shadow-sm border border-gray-200 rounded-lg p-4 sm:p-6 text-sm sm:text-base text-gray-700">
      <p class="mb-2"><strong class="text-gray-900">{{ _("주소") }}:</strong> {{ _("부산광역시 동래구 안남로 78-3 (더 평안빌딩 2층)") }}, 주식회사 유가</p>
      <p class="mb-2"><strong class="text-gray-900">{{ _("전화") }}:</strong> 051-522-3969</p>
      <p class="mb-2"><strong class="text-gray-900">{{ _("팩스") }}:</strong> 051-524-3969</p>
      <p class="mb-4"><strong class="text-gray-900">{{ _("이메일") }}:</strong> ugamedical@naver.com</p>

      <div class="w-full h-64 sm:h-96">
        <iframe
          src="https://www.google.com/maps?q=안남로+78-3&output=embed"
          width="100%"
          height="100%"
          style="border:0;"
          allowfullscreen=""
          loading="lazy"
        ></iframe>
      </div>
    </div>
  </div>
</div>

<script>
function sendEmailCodeContact() {
  const email = document.getElementById("contact_email").value.trim();
  const btn = document.getElementById("send-email-btn");
  const statusEl = document.getElementById("email-status");

  if (!email) return alert("이메일을 입력해주세요.");

  btn.disabled = true;
  btn.textContent = "전송 중...";

  fetch("/send_email_code", {
    method: "POST",
    credentials: "include",
    body: new URLSearchParams({ email })
  })
  .then(res => res.json())
  .then(data => {
    alert(data.message);
    statusEl.textContent = "인증메일이 발송되었습니다.";
    statusEl.className = "text-xs text-green-600 mt-1";
  })
  .catch(err => {
    console.error(err);
    alert("이메일 전송 오류");
  })
  .finally(() => {
    btn.disabled = false;
    btn.textContent = "인증메일 보내기";
  });
}

function verifyEmailCodeContact() {
  const code = document.getElementById("verify_email_code").value.trim();
  const statusEl = document.getElementById("email-status");
  if (!code) return alert("인증코드를 입력해주세요.");

  fetch("/verify_email_code", {
    method: "POST",
    credentials: "include",
    body: new URLSearchParams({ code })
  })
  .then(res => res.json())
  .then(data => {
    alert(data.message);
    if (data.status === "ok") {
      statusEl.textContent = "이메일 인증이 완료되었습니다.";
      statusEl.className = "text-xs text-green-600 mt-1 font-semibold";
    } else {
      statusEl.textContent = "인증에 실패했습니다. 다시 시도해주세요.";
      statusEl.className = "text-xs text-red-500 mt-1";
    }
  })
  .catch(err => {
    console.error(err);
    alert("서버 오류 발생");
  });
}
</script>

<!-- reCAPTCHA -->
<script src="https://www.google.com/recaptcha/api.js" async defer></script>
{% endblock %}