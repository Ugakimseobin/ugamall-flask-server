{% extends "base.html" %}
{% block content %}
<div class="max-w-6xl min-h-[70vh] mx-auto py-6 sm:py-10 flex flex-col md:flex-row px-4 sm:px-6 gap-6">
  <!-- ✅ 왼쪽 사이드바 -->
  <aside class="w-full md:w-1/4 md:pr-6">
    <h2 class="font-bold text-xl sm:text-2xl mb-4 sm:mb-6">{{ _("마이페이지") }}</h2>

    <!-- ✅ 데스크탑: 세로 탭 -->
    <ul class="hidden md:flex md:flex-col md:space-y-2">
      <li><button class="tab-btn w-full text-left px-4 py-3 rounded-lg border border-gray-200 bg-white text-gray-800 hover:bg-gray-200 transition" data-tab="orders">{{ _("주문내역") }}</button></li>
      <li><button class="tab-btn w-full text-left px-4 py-3 rounded-lg border border-gray-200 hover:bg-gray-100 transition" data-tab="info">{{ _("개인정보") }}</button></li>
      <li><button class="tab-btn w-full text-left px-4 py-3 rounded-lg border border-gray-200 hover:bg-gray-100 transition" data-tab="inquiry">{{ _("문의내역") }}</button></li>
      <li><button class="tab-btn w-full text-left px-4 py-3 rounded-lg border border-gray-200 hover:bg-gray-100 transition" data-tab="coupons">{{ _("내 쿠폰함") }}</button></li>
      <li><button class="tab-btn w-full text-left px-4 py-3 rounded-lg border border-gray-200 hover:bg-gray-100 transition" data-tab="returns">{{ _("반품/교환 내역") }}</button></li>
    </ul>

    <!-- ✅ 모바일: 카드형 메뉴 -->
    <div class="flex flex-col gap-3 md:hidden">
      <button class="tab-btn flex items-center justify-between text-left bg-white border border-gray-200 rounded-xl p-3 shadow-sm hover:shadow-md transition" data-tab="orders">
        <span class="text-base font-medium mt-1">{{ _("주문내역") }}</span>
        <span class="text-gray-400 text-lg">›</span>
      </button>

      <button class="tab-btn flex items-center justify-between text-left bg-white border border-gray-200 rounded-xl p-3 shadow-sm hover:shadow-md transition" data-tab="info">
        <span class="text-base font-medium mt-1">{{ _("개인정보") }}</span>
        <span class="text-gray-400 text-lg">›</span>
      </button>

      <button class="tab-btn flex items-center justify-between text-left bg-white border border-gray-200 rounded-xl p-3 shadow-sm hover:shadow-md transition" data-tab="inquiry">
        <span class="text-base font-medium mt-1">{{ _("문의내역") }}</span>
        <span class="text-gray-400 text-lg">›</span>
      </button>

      <button class="tab-btn flex items-center justify-between text-left bg-white border border-gray-200 rounded-xl p-3 shadow-sm hover:shadow-md transition" data-tab="coupons">
        <span class="text-base font-medium mt-1">{{ _("내 쿠폰함") }}</span>
        <span class="text-gray-400 text-lg">›</span>
      </button>

      <button class="tab-btn flex items-center justify-between text-left bg-white border border-gray-200 rounded-xl p-3 shadow-sm hover:shadow-md transition col-span-2 sm:col-span-1" data-tab="returns">
        <span class="text-base font-medium mt-1">{{ _("반품/교환 내역") }}</span>
        <span class="text-gray-400 text-lg">›</span>
      </button>
    </div>
  </aside>

  <!-- ✅ 오른쪽 컨텐츠 -->
  <main class="w-full md:w-3/4 bg-white shadow rounded p-4 sm:p-6">
    <!-- 주문내역 -->
    <section id="tab-orders" class="tab-content">
      <h3 class="text-lg sm:text-xl font-bold mb-4">{{ _("주문내역") }}</h3>

      <!-- 필터 영역 -->
      <div class="bg-gray-50 p-4 rounded-lg shadow-sm mb-5">
        <div class="flex flex-wrap items-center gap-2">
            <!-- 기간 버튼 -->
            <button class="filter-btn px-3 py-1 rounded border border-gray-300 {% if selected_period == '5y' %}bg-green-100 text-green-700{% endif %}" data-range="5y">{{ _("최대(5년)") }}</button>
            <button class="filter-btn px-3 py-1 rounded border border-gray-300 {% if selected_period == '6m' %}bg-green-100 text-green-700{% endif %}" data-range="6m">6{{ _("개월") }}</button>
            <button class="filter-btn px-3 py-1 rounded border border-gray-300 {% if selected_period == '3m' %}bg-green-100 text-green-700{% endif %}" data-range="3m">3{{ _("개월") }}</button>
            <button class="filter-btn px-3 py-1 rounded border border-gray-300 {% if selected_period == '1m' %}bg-green-100 text-green-700{% endif %}" data-range="1m">1{{ _("개월") }}</button>

            <!-- 직접 날짜 입력 -->
            <div class="flex items-center gap-1 ml-2">
            <input type="month" id="startDate" class="border rounded p-1 text-sm" value="{{ start_date or '' }}">
            <span class="text-gray-500">~</span>
            <input type="month" id="endDate" class="border rounded p-1 text-sm" value="{{ end_date or '' }}">
            </div>

            <!-- 검색창 -->
            <input type="text" id="searchOrder" placeholder="{{ _('주문 상품명을 입력하세요') }}"
                class="border rounded px-2 py-1 flex-1 min-w-[150px] text-sm ml-2"
                value="{{ search_query or '' }}">

            <!-- 조회 버튼 -->
            <button id="filterSearch" class="px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600 text-sm">{{ _("조회하기") }}</button>
        </div>
      </div>

      {% if orders|length == 0 %}
        <div class="text-center py-10 text-gray-500">
          <p>{{ _("최근 한달 간 주문내역이 없습니다") }}.</p>
          <button class="mt-4 px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">{{ _("주문내역 전체보기") }}</button>
        </div>
      {% else %}
        <div id="order-list" class="space-y-5">
          {% for order in orders %}
          <div class="bg-white border rounded-lg shadow-sm p-4 hover:shadow-md transition">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-3 border-b pb-2">
              <div>
                <h4 class="font-semibold text-sm sm:text-base">{{ _("주문번호") }}: {{ order.id }}</h4>
                <p class="text-xs text-gray-500">{{ order.created_at|kst }}</p>
              </div>
              <div class="flex items-center gap-2 mt-2 sm:mt-0">
                <span class="text-sm font-semibold text-indigo-600">{{ order.status | status_label }}</span>
                {% if order.status in ["결제대기","입금대기","결제완료"] %}
                <form method="post" action="{{ url_for('cancel_order', order_id=order.id) }}" onsubmit="return confirm('정말 주문을 취소하시겠습니까?');">
                  <button type="submit" class="bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600">
                    {{ _("주문취소") }}
                  </button>
                </form>
                {% endif %}
                {% if order.status == "배송완료" %}
                <button 
                  class="mt-2 bg-yellow-500 text-white text-xs px-2 py-1 rounded hover:bg-yellow-600"
                  onclick="openReturnModal('{{ order.id }}')">
                  반품/교환 신청
                </button>
                {% endif %}
              </div>
            </div>

            <!-- 주문 상품 -->
            <div class="divide-y mt-2">
              {% for item in order.items %}
              <div class="flex items-center gap-3 py-2">
                <img src="{{ url_for('serve_product_image', product_id=item.variant.product.id) }}"
+                    alt="{{ item.variant.product.name }}"
                     class="w-16 h-16 rounded object-cover border">
                <div class="flex-1">
                  <p class="font-semibold text-sm sm:text-base">{{ item.variant.product.name }}</p>
                  <p class="text-xs text-gray-500">
                    {% for key, val in item.variant.options.items() %}
                      {{ key }}: {{ val }}
                    {% endfor %}
                  </p>
                </div>
                <div class="text-right text-sm">
                  <p>{{ item.quantity }}개</p>
                  {% if item.discount_price and item.discount_price < item.original_price %}
                    <p><span class="line-through text-gray-400 mr-1">{{ item.original_price | won }}{{ _("원") }}</span>
                       <span class="text-red-600 font-semibold">{{ item.discount_price | won }}{{ _("원") }}</span></p>
                  {% else %}
                    <p>{{ item.original_price | won }}{{ _("원") }}</p>
                  {% endif %}
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
          {% endfor %}
        </div>
      {% endif %}
      <!-- 로딩 스피너 -->
      <div id="loading-spinner" class="hidden text-center text-gray-500 py-4">
            <div class="animate-spin inline-block w-6 h-6 border-2 border-t-transparent border-gray-400 rounded-full mr-2"></div>
            {{ _("불러오는 중") }}...
      </div>
    </section>

    <!-- 개인정보 변경 -->
    <section id="tab-info" class="tab-content">
      <h3 class="text-lg sm:text-xl font-bold mb-4">{{ _("개인정보 변경") }}</h3>
        <!-- ✅ 비밀번호 확인 폼 -->
      <div id="verify-section" class="space-y-4 text-sm sm:text-base">
        <p class="text-gray-600 text-sm mb-2">
          {{ _("개인정보 보호를 위해 비밀번호를 다시 입력해주세요") }}.
        </p>
        <form id="verify-form" method="post" action="{{ url_for('verify_password') }}" class="space-y-3">
          <input type="password" name="verify_password" placeholder="{{ _('현재 비밀번호') }}" required
                class="w-full border p-2 rounded focus:ring-2 focus:ring-indigo-400">
          <button type="submit"
                  class="w-full bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700 text-sm">
            {{ _("확인") }}
          </button>
        </form>
      </div>
      <div id="edit-section" class="hidden">
        <form method="post" class="space-y-4 text-sm sm:text-base">
          <input type="hidden" name="form_type" value="info">
          <div>
            <label class="block font-semibold">{{ _("이메일") }}</label>
            <input type="email" value="{{ user.email }}" readonly
                  class="w-full border p-2 rounded bg-gray-100 text-sm sm:text-base">
          </div>
          <div>
            <label class="block font-semibold">{{ _("이름") }}</label>
            <input type="text" name="name" value="{{ user.name }}" class="w-full border p-2 rounded">
          </div>
          <div>
            <label class="block font-semibold">{{ _("주소") }}</label>
            <div class="flex flex-col sm:flex-row sm:space-x-2 mb-2">
              <input type="text" id="baseAddress" name="base_address"
                    value="{{ user.base_address or '' }}" placeholder="{{ _('기본주소') }}"
                    class="border p-2 rounded w-full sm:w-1/2 mb-2 sm:mb-0" readonly>
              <button type="button" onclick="execDaumPostcode()"
                      class="px-3 py-2 bg-indigo-600 text-white rounded text-sm sm:text-base">{{ _("주소찾기") }}</button>
            </div>
            <input type="text" id="detailAddress" name="detail_address"
                  value="{{ user.detail_address or '' }}" placeholder="{{ _('상세주소') }}"
                  class="w-full border p-2 rounded">
          </div>
          <div>
            <label class="text-sm sm:text-base">
              <input type="checkbox" name="agree_marketing" {% if user.agree_marketing %}checked{% endif %}>
              {{ _("마케팅/혜택 수신 동의") }}
            </label>
          </div>
          <button type="submit" class="w-full bg-indigo-600 text-white py-2 rounded">{{ _("저장") }}</button>
        </form>

        <hr class="my-8">

        <h3 class="text-lg sm:text-xl font-bold mb-4">{{ _("비밀번호 변경") }}</h3>
        <form method="post" class="space-y-4 text-sm sm:text-base">
          <input type="hidden" name="form_type" value="password">
          <div>
            <label class="block font-semibold">{{ _("현재 비밀번호") }}</label>
            <input type="password" name="current_password" class="w-full border p-2 rounded" required>
          </div>
          <div>
            <label class="block font-semibold">{{ _("새 비밀번호") }}</label>
            <input type="password" name="new_password" class="w-full border p-2 rounded" required>
          </div>
          <div>
            <label class="block font-semibold">{{ _("새 비밀번호 확인") }}</label>
            <input type="password" name="new_password_confirm" class="w-full border p-2 rounded" required>
          </div>
          <button type="submit" class="w-full bg-red-600 text-white py-2 rounded">{{ _("비밀번호 변경") }}</button>
        </form>

        <hr class="my-8">

        <div class="flex flex-col items-end mt-6 text-right">
          <h3 class="text-lg sm:text-xl font-bold mb-2 text-red-600">{{ _("회원탈퇴") }}</h3>
          <button type="button" onclick="openDeleteModal()" 
                  class="w-16 bg-red-600 text-sm text-white py-2 rounded hover:bg-red-700 transition mb-1">
            {{ _("회원탈퇴") }}
          </button>
          <p class="whitespace-nowrap text-xs text-gray-600 text-right">
            {{ _("탈퇴 시 모든 주문내역, 쿠폰, 포인트 정보가 삭제되며 복구가 불가능합니다") }}.
          </p>
        </div>
      </div>
    </section>

    <!-- 문의내역 -->
    <section id="tab-inquiry" class="tab-content hidden">
      <h3 class="text-lg sm:text-xl font-bold mb-4">{{ _("문의 내역") }}</h3>
      {% if inquiries|length == 0 %}
        <p class="text-gray-500">{{ _("등록된 문의가 없습니다.") }}</p>
      {% else %}
        <div class="space-y-6 text-sm sm:text-base">
          {% for q in inquiries %}
          <div class="border rounded-lg shadow p-4 bg-white">
            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-2">
              <h4 class="font-bold">{{ q.title }}</h4>
              <p class="text-xs sm:text-sm text-gray-500">{{ q.created_at|kst }}</p>
            </div>
            <p class="mb-3">{{ q.content }}</p>
            <p class="text-xs sm:text-sm text-gray-600">{{ _("상태") }}: {{ q.status }}</p>
            {% if q.answer %}
            <div class="mt-3 border-t pt-2">
              <p class="font-bold text-indigo-600">[{{ _("답변") }}]</p>
              <p>{{ q.answer }}</p>
              <p class="text-xs text-gray-500">{{ q.answered_at|kst }}</p>
            </div>
            {% endif %}
          </div>
          {% endfor %}
        </div>
      {% endif %}
    </section>

    <section id="tab-coupons" class="tab-content hidden">
        <h3 class="text-lg sm:text-xl font-bold mb-4">{{ _("내 쿠폰함") }}</h3>
        {% if user.coupons|length == 0 %}
            <p class="text-gray-500">{{ _("보유한 쿠폰이 없습니다.") }}</p>
        {% else %}
            <table class="w-full text-sm border">
            <thead>
                <tr class="bg-gray-100 text-left">
                <th class="border px-3 py-2">{{ _("쿠폰명") }}</th>
                <th class="border px-3 py-2">{{ _("할인") }}</th>
                <th class="border px-3 py-2">{{ _("조건") }}</th>
                <th class="border px-3 py-2">{{ _("유효기간") }}</th>
                <th class="border px-3 py-2">{{ _("상태") }}</th>
                </tr>
            </thead>
            <tbody>
                {% for uc in user.coupons %}
                <tr>
                <td class="border px-3 py-2">{{ uc.coupon.name }}</td>
                <td class="border px-3 py-2">
                    {% if uc.coupon.discount_type == "percent" %}
                    {{ uc.coupon.discount_value }}%
                    {% else %}
                    {{ uc.coupon.discount_value }}{{ _("원") }}
                    {% endif %}
                </td>
                <td class="border px-3 py-2">{{ _("최소") }} {{ uc.coupon.min_amount }}{{ _("원") }} {{ _("이상") }}</td>
                <td class="border px-3 py-2">{{ uc.coupon.valid_from.date() }} ~ {{ uc.coupon.valid_to.date() }}</td>
                <td class="border px-3 py-2">
                    {% if uc.used %}
                    <span class="text-red-500">{{ _("사용됨") }}</span>
                    {% else %}
                    <span class="text-green-600">{{ _("미사용") }}</span>
                    {% endif %}
                </td>
                </tr>
                {% endfor %}
            </tbody>
            </table>
        {% endif %}
    </section>

    <section id="tab-returns" class="tab-content hidden">
      <h3 class="text-lg sm:text-xl font-bold mb-4">{{ _("반품 / 교환 내역") }}</h3>
      {% if user.returns|length == 0 %}
        <p class="text-gray-500">{{ _("신청 내역이 없습니다") }}.</p>
      {% else %}
      <table class="w-full text-sm border">
        <thead>
          <tr class="bg-gray-100 text-left">
            <th class="border px-3 py-2">{{ _("주문번호") }}</th>
            <th class="border px-3 py-2">{{ _("종류") }}</th>
            <th class="border px-3 py-2">{{ _("사유") }}</th>
            <th class="border px-3 py-2">{{ _("상태") }}</th>
            <th class="border px-3 py-2">{{ _("신청일") }}</th>
          </tr>
        </thead>
        <tbody>
          {% for r in user.returns %}
          <tr>
            <td class="border px-3 py-2">{{ r.order_id }}</td>
            <td class="border px-3 py-2">{{ "반품" if r.type == "return" else "교환" }}</td>
            <td class="border px-3 py-2">{{ r.reason }}</td>
            <td class="border px-3 py-2">{{ r.status }}</td>
            <td class="border px-3 py-2">{{ r.created_at|kst }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% endif %}
    </section>

    <!-- 반품/교환 신청 모달 -->
    <div id="returnModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div class="bg-white rounded-lg p-6 w-full max-w-md">
        <h3 class="text-lg font-bold mb-3">{{ _("반품 / 교환 신청") }}</h3>
        <form method="POST" action="{{ url_for('request_return') }}" class="space-y-3">
          <input type="hidden" name="order_id" id="returnOrderId">
          <label class="block text-sm font-semibold">{{ _("신청 종류") }}</label>
          <select name="type" class="w-full border rounded p-2">
            <option value="return">{{ _("반품") }}</option>
            <option value="exchange">{{ _("교환") }}</option>
          </select>

          <label class="block text-sm font-semibold">{{ _("사유") }}</label>
          <textarea name="reason" rows="3" class="w-full border rounded p-2" required></textarea>

          <div class="flex justify-end gap-2 pt-3">
            <button type="button" onclick="closeReturnModal()" class="px-4 py-2 bg-gray-300 rounded">{{ _("취소") }}</button>
            <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">{{ _("신청") }}</button>
          </div>
        </form>
      </div>
    </div>

    <!-- 회원탈퇴 확인 모달 -->
    <div id="deleteModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div class="bg-white rounded-lg p-6 w-full max-w-md shadow-lg">
        <h3 class="text-lg font-bold mb-4 text-red-600">{{ _("회원탈퇴 확인") }}</h3>
        <p class="text-sm text-gray-700 mb-4">
          {{ _("정말로 탈퇴하시겠습니까") }}?<br>
          {{ _("이 작업은 되돌릴 수 없습니다") }}.
        </p>
        <form id="deleteForm" method="POST" action="/delete_account">
          <div class="mb-3">
            <input type="password" name="confirm_password" placeholder="{{ _('비밀번호를 입력해주세요') }}" 
                  required class="w-full border p-2 rounded focus:ring-2 focus:ring-red-400">
          </div>
          <div class="flex justify-end gap-2">
            <button type="button" onclick="closeDeleteModal()" class="px-4 py-2 bg-gray-300 rounded">{{ _("취소") }}</button>
            <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">{{ _("탈퇴") }}</button>
          </div>
        </form>
      </div>
    </div>
  </main>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const tabContents = document.querySelectorAll(".tab-content");
  const tabButtons = document.querySelectorAll(".tab-btn");

  // ✅ 공통 함수: 탭 전환
  function showTab(tabName) {
    tabContents.forEach(c => c.classList.add("hidden"));
    document.getElementById("tab-" + tabName).classList.remove("hidden");

    tabButtons.forEach(b => b.classList.remove("bg-indigo-600","text-white"));
    tabButtons.forEach(b => b.classList.add("bg-gray-200"));
    document.querySelector(`[data-tab="${tabName}"]`).classList.add("bg-indigo-600","text-white");
  }

  // 기본 탭 (주문내역)
  showTab("orders");

  // 탭 버튼 클릭 시
  tabButtons.forEach(btn => {
    btn.addEventListener("click", () => showTab(btn.dataset.tab));
  });

  // ✅ AJAX 주문내역 갱신 함수
  async function loadOrders(params) {
    const list = document.getElementById("order-list");
    const spinner = document.getElementById("loading-spinner");

    // 다른 탭 숨기고 주문내역 탭만 보여주기
    showTab("orders");

    list.classList.add("hidden");
    spinner.classList.remove("hidden");

    const query = new URLSearchParams(params).toString();
    const res = await fetch(`/mypage/orders?${query}`);
    const data = await res.json();

    spinner.classList.add("hidden");
    list.classList.remove("hidden");

    if (data.length === 0) {
      list.innerHTML = `<p class="text-gray-500 text-center py-6">{{ _("주문 내역이 없습니다") }}.</p>`;
      return;
    }

    // 주문내역 렌더링
    list.innerHTML = data.map(o => `
      <div class="border rounded-lg shadow p-4 bg-white hover:shadow-md transition">
        <div class="flex justify-between mb-2 border-b pb-2">
          <div>
            <h4 class="font-bold text-sm sm:text-base">주문번호: ${o.id}</h4>
            <p class="text-xs sm:text-sm text-gray-500">주문일: ${o.created_at}</p>
          </div>
          <p class="text-gray-600 text-sm">${o.status_label}</p>
        </div>
        <table class="w-full text-left text-xs sm:text-sm mt-2">
          <tbody>
            ${o.items.map(item => `
              <tr class="border-t">
                <td class="w-[70px] sm:w-[90px] py-2">
                  <img src="${item.image}" class="w-16 h-16 object-cover rounded border">
                </td>
                <td class="py-2">
                  <b>${item.name}</b><br>
                  <span class="text-gray-500 text-xs">${item.quantity}개</span>
                </td>
                <td class="py-2 text-right">
                  ${item.discount_price && item.discount_price < item.original_price
                    ? `<span class="line-through text-gray-400 mr-1">${item.original_price}원</span>
                       <span class="text-red-600 font-bold">${item.discount_price}원</span>`
                    : `${item.original_price}원`}
                </td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      </div>
    `).join("");
  }

  // ✅ 기간 버튼 클릭 시
  document.querySelectorAll(".filter-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const range = btn.dataset.range;
      loadOrders({ period: range });
    });
  });

  // ✅ 조회 버튼 클릭 시
  document.getElementById("filterSearch").addEventListener("click", () => {
    const start = document.getElementById("startDate").value;
    const end = document.getElementById("endDate").value;
    const q = document.getElementById("searchOrder").value.trim();
    loadOrders({ start_date: start, end_date: end, q });
  });
});
</script>


<!-- 카카오 주소검색 그대로 -->
<script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script>
function execDaumPostcode() {
  new daum.Postcode({
    oncomplete: function(data) {
      document.getElementById("postcode").value = data.zonecode;
      document.getElementById("baseAddress").value = data.roadAddress ? data.roadAddress : data.jibunAddress;
      document.getElementById("detailAddress").focus();
    }
  }).open();
}
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const verifyForm = document.getElementById("verify-form");
  if (!verifyForm) return;

  verifyForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const pw = e.target.verify_password.value.trim();
    if (!pw) return alert("{{ _('비밀번호를 입력해주세요') }}.");

    const res = await fetch("{{ url_for('verify_password') }}", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ password: pw })
    });

    if (!res.ok) {
      alert("서버 응답 오류 (" + res.status + ")");
      return;
    }

    const data = await res.json();
    if (data.success) {
      document.getElementById("verify-section").classList.add("hidden");
      document.getElementById("edit-section").classList.remove("hidden");
    } else {
      alert("{{ _('비밀번호가 올바르지 않습니다') }}.");
    }
  });
});
</script>

<!-- 환불/교환 모달 -->
<script>
function openReturnModal(orderId) {
  document.getElementById("returnModal").classList.remove("hidden");
  document.getElementById("returnOrderId").value = orderId;
}
function closeReturnModal() {
  document.getElementById("returnModal").classList.add("hidden");
}
</script>

<script>
function openDeleteModal() {
  document.getElementById("deleteModal").classList.remove("hidden");
}
function closeDeleteModal() {
  document.getElementById("deleteModal").classList.add("hidden");
}

// 회원탈퇴 요청 처리
document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("deleteForm");
  if (!form) return;

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const pw = e.target.confirm_password.value.trim();
    if (!pw) return alert("비밀번호를 입력해주세요.");

    const res = await fetch("/delete_account", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ password: pw }),  // ✅ 수정됨
    });

    const data = await res.json();
    if (data.success) {
      alert("회원탈퇴가 완료되었습니다.");
      window.location.href = "/";
    } else {
      alert(data.message || "비밀번호가 올바르지 않습니다.");
    }
  });
});
</script>
{% endblock %}
