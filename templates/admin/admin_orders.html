{% extends "base.html" %}
{% block content %}
<div class="max-w-7xl mx-auto bg-white p-4 sm:p-6 shadow rounded mt-6 sm:mt-8">
  <h1 class="text-xl sm:text-2xl font-bold mb-4 sm:mb-6">주문 관리</h1>

  <!-- ✅ 주문 필터 영역 -->
  <div class="bg-gray-50 p-4 rounded-lg shadow-sm mb-5">
    <form id="filterForm" method="get" action="{{ url_for('admin_orders') }}" class="flex flex-wrap items-center gap-2">
      <!-- 기간 버튼 -->
      <button type="button" class="filter-btn px-3 py-1 rounded border border-gray-300 {% if selected_period == '5y' %}bg-green-100 text-green-700{% endif %}" data-range="5y">최대(5년)</button>
      <button type="button" class="filter-btn px-3 py-1 rounded border border-gray-300 {% if selected_period == '6m' %}bg-green-100 text-green-700{% endif %}" data-range="6m">6개월</button>
      <button type="button" class="filter-btn px-3 py-1 rounded border border-gray-300 {% if selected_period == '3m' %}bg-green-100 text-green-700{% endif %}" data-range="3m">3개월</button>
      <button type="button" class="filter-btn px-3 py-1 rounded border border-gray-300 {% if selected_period == '1m' %}bg-green-100 text-green-700{% endif %}" data-range="1m">1개월</button>

      <!-- 직접 날짜 입력 -->
      <div class="flex items-center gap-1 ml-2">
        <input type="month" id="startDate" name="start_date" class="border rounded p-1 text-sm" value="{{ start_date or '' }}">
        <span class="text-gray-500">~</span>
        <input type="month" id="endDate" name="end_date" class="border rounded p-1 text-sm" value="{{ end_date or '' }}">
      </div>

      <!-- 검색창 -->
      <input type="text" name="q" id="searchOrder" placeholder="주문자명, 이메일, 상품명 검색"
             class="border rounded px-2 py-1 flex-1 min-w-[200px] text-sm ml-2"
             value="{{ search_query or '' }}">

      <!-- 조회 버튼 -->
      <button type="submit" id="filterSearch" class="px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600 text-sm">
        조회하기
      </button>
    </form>
  </div>

  <!-- 데스크탑 : 테이블 -->
  <div class="overflow-x-auto hidden md:block">
    <table class="w-full border-collapse text-sm">
      <thead>
        <tr class="bg-gray-100 text-left">
          <th class="border px-3 py-2">주문번호</th>
          <th class="border px-3 py-2">주문일시</th>
          <th class="border px-3 py-2">주문자</th>
          <th class="border px-3 py-2">상품/수량</th>
          <th class="border px-3 py-2">총액</th>
          <th class="border px-3 py-2 w-[120px]">결제상태</th>
          <th class="border px-3 py-2">배송지</th>
          <th class="border px-3 py-2 w-[120px]">주문상태</th>
          <th class="border px-3 py-2 w-[230px]">작업</th>
        </tr>
      </thead>
      <tbody>
        {% for o in orders %}
        <tr class="hover:bg-gray-50 align-top">
          <td class="border px-3 py-2">{{ o.id }}</td>
          <td class="border px-3 py-2">
            {{ o.created_at|kst if o.created_at else '-' }}
          </td>

          <td class="border px-3 py-2">
            <div class="font-medium">{{ o._who }}</div>
            <div class="text-gray-500">{{ o._email }}</div>
            <div class="text-gray-500">{{ o._phone }}</div>
          </td>

          <td class="border px-3 py-2 hover:underline" onclick="openItemsModal({{ o.id }})">
            <div class="font-medium">{{ o._summary }}</div>
            <div class="text-gray-500">총 {{ o._qty_sum }}개</div>
          </td>

          <td class="border px-3 py-2 font-semibold">
            <div>정가합: {{ o._items_total|won }}원</div>
            {% if o._discount > 0 %}
                <div class="text-red-600">할인: -{{ o._discount|won }}원{% if o._coupon_name %} ({{ o._coupon_name }}){% endif %}</div>
            {% endif %}
            <div class="text-indigo-700">결제금액: {{ o._final_amount|won }}원</div>
          </td>

          <td class="border px-3 py-2">
            <span class="block bg-gray-100 px-2 py-[2px] text-sm">{{ o.payment_method }}</span>
            <span class="block rounded bg-gray-100 px-2 py-[2px] text-sm">
              {% if o.payment_method == "무통장입금" %}
                {% if o._pay_status == "paid" %}
                    입금완료
                {% else %}
                    입금대기
                {% endif %}
              {% elif o._pay_status %}
                {{ o._pay_status | status_label }}
              {% else %}
                {{ o.payment_method or "-" }}
              {% endif %}
            </span>

            {% if o.payment_method == "무통장입금" and o.status == "입금대기" %}
                <form method="post" action="{{ url_for('admin_confirm_deposit', order_id=o.id) }}" class="inline">
                <button type="submit"
                        class="bg-green-600 hover:bg-green-700 text-white px-2 py-[2px] rounded text-sm"
                        onclick="return confirm('주문을 결제완료로 변경합니다.');">
                    입금 확인
                </button>
                </form>
            {% endif %}
          </td>

          <td class="border px-3 py-2">{{ o._address }}</td>

          <td class="border px-3 py-2">
            <span class="inline-block rounded bg-gray-100 px-2 py-0.5">
              {{ o.status | status_label }}
            </span>
          </td>

          <td class="border px-3 py-2">
            <!-- 상태 변경 -->
            <form method="post" action="{{ url_for('admin_orders') }}" class="flex flex-wrap items-center gap-2 mb-2">
              <input type="hidden" name="order_id" value="{{ o.id }}">
              <select name="status" class="border rounded px-2 py-1 text-sm">
                {% for opt in status_options %}
                  <option value="{{ opt.value }}" {% if o.status == opt.value %}selected{% endif %}>
                    {{ opt.label }}
                  </option>
                {% endfor %}
              </select>
              <button type="submit" class="bg-indigo-600 text-white px-3 py-1 rounded text-sm">상태 변경</button>
            </form>

            <!-- 환불(결제취소) -->
            <form method="post" action="{{ url_for('admin_cancel_order', order_id=o.id) }}" class="flex flex-wrap items-center gap-2">
              <input type="text" name="reason" placeholder="사유(선택)"
                     class="border rounded px-2 py-1 text-xs grow md:grow-0">
              <input type="number" name="amount" min="1" placeholder="부분취소 금액"
                     class="border rounded px-2 py-1 text-xs w-32">

              {# 가상계좌 '입금 후' 취소 시에만 환불 계좌 필요 #}
              {% if o.payment and o.payment.method == 'vbank' and o._pay_status == 'paid' %}
                <!-- ✅ 은행 선택 -->
                <select name="refund_bank" class="border rounded px-2 py-1 text-xs w-40">
                  <option value="">은행 선택</option>
                  <option value="국민은행">국민은행</option>
                  <option value="신한은행">신한은행</option>
                  <option value="우리은행">우리은행</option>
                  <option value="하나은행">하나은행</option>
                  <option value="농협은행">농협은행</option>
                  <option value="기업은행">기업은행</option>
                  <option value="카카오뱅크">카카오뱅크</option>
                  <option value="토스뱅크">토스뱅크</option>
                  <option value="새마을금고">새마을금고</option>
                  <option value="부산은행">부산은행</option>
                  <option value="대구은행">대구은행</option>
                  <option value="경남은행">경남은행</option>
                </select>

                <!-- ✅ 계좌번호 -->
                <input type="text" name="refund_account"
                      placeholder="환불 계좌번호"
                      class="border rounded px-2 py-1 text-xs w-44">

                <!-- ✅ 예금주 -->
                <input type="text" name="refund_holder"
                      placeholder="예금주"
                      class="border rounded px-2 py-1 text-xs w-32">
              {% endif %}

              <button type="submit"
                      class="bg-red-600 text-white px-3 py-1 rounded text-xs"
                      onclick="return confirm('정말 환불(결제취소) 하시겠습니까?');">
                환불
              </button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <div id="itemsModal"
            class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
        <div class="bg-white rounded-xl shadow-2xl w-11/12 max-w-md p-6 relative animate-fadeIn">
            <h3 class="text-lg font-bold mb-4 text-indigo-700">주문 상품 상세</h3>
            <div id="itemsList" class="text-sm text-gray-700 space-y-2 max-h-80 overflow-y-auto"></div>
            <button onclick="closeItemsModal()"
                    class="absolute top-3 right-4 text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
        </div>
    </div>
  </div>

  <!-- 모바일 : 카드 -->
  <div class="space-y-4 md:hidden">
    {% for o in orders %}
    <div class="border rounded-lg shadow p-4 text-sm">
      <div class="flex justify-between items-center mb-1">
        <div class="font-semibold">주문번호 {{ o.id }}</div>
        <div class="text-gray-500">{{ o.created_at|kst if o.created_at else '-' }}</div>
      </div>
      <div class="mb-1"><span class="text-gray-500">주문자</span> : {{ o._who }} <span class="text-gray-500">/</span> {{ o._phone }}</div>
      <div class="mb-1 text-gray-500">{{ o._email }}</div>
      <div class="mb-1"><span class="text-gray-500">상품</span> : {{ o._summary }} (총 {{ o._qty_sum }}개)</div>

      <div class="mb-1">
        <span class="text-gray-500">총액</span> : 
        <b>
        {% if o.items and o.items[0].discount_price and o.items[0].discount_price < o.items[0].original_price %}
            <span class="line-through text-gray-400">{{ o.items[0].original_price|comma }}원</span>
            <span class="text-red-600 ml-1">{{ o.items[0].discount_price|comma }}원</span>
            <div class="text-xs text-gray-500">({{ o.items[0].discount_reason or '할인 적용' }})</div>
        {% elif o.items %}
            {{ o.items[0].original_price|comma }}원
        {% else %}
            -
        {% endif %}
        </b>
      </div>
      <div class="mb-1"><span class="text-gray-500">결제</span> :
        <span class="inline-block rounded bg-gray-100 px-2 py-0.5">
          {% if o.payment_method == "무통장입금" %}
            {% if o._pay_status == "paid" %}
                입금완료
            {% else %}
                입금대기
            {% endif %}
          {% elif o._pay_status %}
            {{ o._pay_status | status_label }}
          {% else %}
            -
          {% endif %}

          {% if o.payment_method == "무통장입금" and o.status == "입금대기" %}
                <form method="post" action="{{ url_for('admin_confirm_deposit', order_id=o.id) }}" class="inline">
                <button type="submit"
                        class="bg-green-600 hover:bg-green-700 text-white px-2 py-0.5 rounded text-sm"
                        onclick="return confirm('주문을 결제완료로 변경합니다.');">
                    입금 확인
                </button>
                </form>
            {% endif %}
        </span>
      </div>
      <div class="mb-1"><span class="text-gray-500">배송지</span> : {{ o._address }}</div>
      <div class="mb-3"><span class="text-gray-500">주문상태</span> :
        <span class="inline-block rounded bg-gray-100 px-2 py-0.5">
          {{ o.status | status_label }}
        </span>
      </div>

      <!-- 상태 변경 -->
      <form method="post" action="{{ url_for('admin_orders') }}" class="flex items-center gap-2 mb-2">
        <input type="hidden" name="order_id" value="{{ o.id }}">
        <select name="status" class="border rounded px-2 py-1 text-sm flex-1">
          {% for opt in status_options %}
            <option value="{{ opt.value }}" {% if o.status == opt.value %}selected{% endif %}>
              {{ opt.label }}
            </option>
          {% endfor %}
        </select>
        <button type="submit" class="bg-indigo-600 text-white px-3 py-1 rounded text-sm">변경</button>
      </form>

      <!-- 환불(결제취소) -->
      <form method="post" action="{{ url_for('admin_cancel_order', order_id=o.id) }}" class="space-y-2">
        <div class="flex flex-col gap-2">
          <input type="text" name="reason" placeholder="사유(선택)" class="border rounded px-2 py-1 text-xs">
          <input type="number" name="amount" min="1" placeholder="부분취소 금액" class="border rounded px-2 py-1 text-xs">
        </div>

        {% if o.payment and o.payment.method == 'vbank' and o._pay_status == 'paid' %}
        <div class="flex flex-col gap-2">
          <input type="text" name="refund_bank" placeholder="은행코드(예:004)" class="border rounded px-2 py-1 text-xs">
          <input type="text" name="refund_account" placeholder="환불 계좌번호" class="border rounded px-2 py-1 text-xs">
          <input type="text" name="refund_holder" placeholder="예금주" class="border rounded px-2 py-1 text-xs">
        </div>
        {% endif %}

        <button type="submit"
                class="bg-red-600 text-white px-3 py-1 rounded text-sm w-full"
                onclick="return confirm('정말 환불(결제취소) 하시겠습니까?');">
          환불
        </button>
      </form>
    </div>
    {% endfor %}
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // 기간 버튼 클릭 시 자동 폼 전송
  document.querySelectorAll(".filter-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const range = btn.dataset.range;
      const form = document.getElementById("filterForm");
      const hidden = document.createElement("input");
      hidden.type = "hidden";
      hidden.name = "period";
      hidden.value = range;
      form.appendChild(hidden);
      form.submit();
    });
  });
});
</script>

<script>
function openItemsModal(orderId) {
  // 서버에서 해당 주문의 상품 목록을 JSON으로 요청
  fetch(`/admin/order_items/${orderId}`)
    .then(res => res.json())
    .then(data => {
      const list = document.getElementById("itemsList");
      list.innerHTML = "";
      if (data.items && data.items.length > 0) {
        data.items.forEach(it => {
          const el = document.createElement("div");
          el.innerHTML = `
            <div class="flex justify-between border-b pb-1">
              <span>${it.name} (${it.variant || ""}) × ${it.qty}개</span>
              <span class="font-semibold">${it.price.toLocaleString()}원</span>
            </div>
          `;
          list.appendChild(el);
        });
      } else {
        list.innerHTML = "<p class='text-gray-500 text-center py-4'>상품 정보가 없습니다.</p>";
      }
      document.getElementById("itemsModal").classList.remove("hidden");
    })
    .catch(err => console.error(err));
}

function closeItemsModal() {
  document.getElementById("itemsModal").classList.add("hidden");
}
</script>
{% endblock %}
