{% extends "base.html" %}
{% block content %}
<div class="flex flex-col md:flex-row max-w-7xl mx-auto min-h-[70vh] py-8 md:py-12 px-4 md:px-6 gap-8">

  <!-- ✅ 왼쪽 필터 -->
  <aside class="w-full md:w-1/4 bg-white shadow-lg rounded-2xl p-6 border border-gray-100 
              md:sticky md:top-24 h-fit md:h-auto overflow-auto md:overflow-visible z-10">
    <h3 class="font-bold text-xl text-indigo-700 mb-6 flex items-center gap-2">
      <i class="fa-solid fa-sliders-h text-indigo-500">{{ _("상품 필터") }}</i> 
    </h3>

    <!-- 상품명 -->
    <div class="mb-5">
      <label class="block text-sm font-semibold mb-1 text-gray-700">{{ _("상품명") }}</label>
      <input id="filter-name" name="name"
             class="border border-gray-300 p-2 w-full rounded-lg focus:ring-2 focus:ring-indigo-300"
             placeholder="{{ _('예: 밴드, 보호대') }}"
             value="{{ request.args.get('name', '') }}">
    </div>

    <!-- 분야 -->
    <div class="mb-5">
      <label class="block text-sm font-semibold mb-1 text-gray-700">{{ _("분야") }}</label>
      <select id="filter-category" name="category"
              class="border border-gray-300 p-2 w-full rounded-lg focus:ring-2 focus:ring-indigo-300">
        <option value="">{{ _("전체 보기") }}</option>
        {% for cat in categories %}
          <option value="{{ cat }}" {% if request.args.get('category') == cat %}selected{% endif %}>{{ cat }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- 가격 -->
    <div class="mb-6">
      <label class="block text-sm font-semibold mb-2 text-gray-700">{{ _("가격 범위") }}</label>
      <div id="price-slider" class="mb-3"></div>

      <div class="flex items-center justify-between gap-2">
        <input id="price-min-input" type="number"
               class="w-1/2 border border-gray-300 p-2 rounded-lg text-sm focus:ring-2 focus:ring-indigo-300"
               value="{{ request.args.get('price_min', 0) }}" min="0" step="1000">
        <span class="text-gray-400">~</span>
        <input id="price-max-input" type="number"
               class="w-1/2 border border-gray-300 p-2 rounded-lg text-sm focus:ring-2 focus:ring-indigo-300"
               value="{{ request.args.get('price_max', 1000000) }}" max="1000000" step="1000">
      </div>
    </div>

    <button id="apply-filters" data-baseurl="{{ url_for('products') }}"
      class="w-full bg-indigo-600 text-white font-semibold py-2.5 rounded-lg shadow hover:bg-indigo-700 transition">
      {{ _("필터 적용") }}
    </button>
  </aside>

  <!-- ✅ 오른쪽 상품 목록 -->
  <main class="w-full md:w-3/4">
    <!-- 정렬 바 -->
    <div class="flex flex-col sm:flex-row justify-between items-center mb-6 sm:mb-8 bg-white shadow rounded-xl p-4 border border-gray-100">
      <div class="text-gray-700 font-semibold text-sm sm:text-base">
        {{ _("총") }} <span class="text-indigo-600">{{ products|length }}</span>{{ _("개 상품") }}
      </div>
      <div class="flex items-center space-x-3 mt-3 sm:mt-0">
        <label for="sort" class="text-sm font-medium text-gray-600">{{ _("정렬") }}</label>
        <select id="sort" name="sort"
                class="border border-gray-300 rounded-lg px-2 py-1 text-sm focus:ring-2 focus:ring-indigo-300">
          <option value="new" {% if request.args.get('sort') == 'new' %}selected{% endif %}>{{ _("최신순") }}</option>
          <option value="low" {% if request.args.get('sort') == 'low' %}selected{% endif %}>{{ _("낮은 가격순") }}</option>
          <option value="high" {% if request.args.get('sort') == 'high' %}selected{% endif %}>{{ _("높은 가격순") }}</option>
          <option value="name" {% if request.args.get('sort') == 'name' %}selected{% endif %}>{{ _("이름순") }}</option>
        </select>
      </div>
    </div>

    {% if products|length == 0 %}
      <div class="text-center text-gray-500 py-20 text-lg">등록된 상품이 없습니다.</div>
    {% else %}
    <div class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 gap-6">
      {% for p in products %}
        <a href="{{ url_for('product_detail', product_id=p.id) }}"
           class="block bg-white rounded-2xl shadow-md hover:shadow-xl overflow-hidden transform hover:-translate-y-1 transition duration-300">
          <img src="{{ url_for('static', filename='images/' ~ p.image) }}"
               class="h-48 sm:h-56 w-full object-cover transition-transform duration-300 hover:scale-105">
          <div class="p-4">
            <h3 class="font-bold text-gray-800 text-sm sm:text-base truncate">{{ p.name }}</h3>
            <p class="text-indigo-600 font-semibold text-sm sm:text-base mt-1">{{ p.base_price|won }}원</p>
          </div>
        </a>
      {% endfor %}
    </div>
    {% endif %}
  </main>
</div>

<!-- ✅ 안내사항 팝업 -->
<div id="notice-popup"
     class="fixed top-24 right-6 md:right-20 w-64 sm:w-72 bg-yellow-100 shadow-2xl rounded-xl p-4 sm:p-5 z-30 hidden animate-fade-in cursor-move"
     style="font-family: 'Nanum Pen Script', cursive;">
  <div class="flex justify-between items-center mb-2">
    <h3 class="font-bold text-lg sm:text-xl text-gray-800">{{ _("안내사항") }} 💬</h3>
    <button onclick="closeNotice()" class="text-gray-500 hover:text-gray-800 text-lg font-bold">×</button>
  </div>
  <p class="text-gray-700 text-sm sm:text-base leading-relaxed">
    {{ _("유가몰은 모든 제품에") }}  
    <span class="font-bold text-indigo-700">{{ _("정품 UDI") }}</span>{{ _("를 제공합니다.") }}<br>
    {{ _("신뢰할 수 있는 의료 쇼핑몰, 유가몰입니다 💙") }}
  </p>
</div>

<style>
@keyframes fade-in {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}
.animate-fade-in { animation: fade-in 0.6s ease forwards; }
</style>

<script>
// ✅ 필터 및 정렬 적용
document.getElementById("apply-filters").addEventListener("click", applyFilters);
document.getElementById("sort").addEventListener("change", applyFilters);

function applyFilters() {
  const name = document.getElementById("filter-name").value;
  const category = document.getElementById("filter-category").value;
  const priceMin = document.getElementById("price-min-input").value;
  const priceMax = document.getElementById("price-max-input").value;
  const sort = document.getElementById("sort").value;

  let url = new URL("{{ url_for('products') }}", window.location.origin);
  url.searchParams.set("name", name);
  url.searchParams.set("category", category);
  url.searchParams.set("price_min", priceMin);
  url.searchParams.set("price_max", priceMax);
  url.searchParams.set("sort", sort);

  window.location.href = url.toString();
}

// ✅ 안내 팝업 로직
const popupKey = "uga_notice_seen";

function closeNotice() {
  document.getElementById("notice-popup").classList.add("hidden");
  const today = new Date();
  today.setHours(23,59,59,999);
  localStorage.setItem(popupKey, today.getTime());
}

window.addEventListener("DOMContentLoaded", () => {
  const popup = document.getElementById("notice-popup");
  const saved = localStorage.getItem(popupKey);
  const now = new Date().getTime();
  if (!saved || now > parseInt(saved)) {
    popup.classList.remove("hidden");
  }
  makeDraggable(popup);
});

// ✅ 팝업 드래그 가능하게
function makeDraggable(el) {
  let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
  el.onmousedown = dragMouseDown;
  function dragMouseDown(e) {
    e.preventDefault();
    pos3 = e.clientX;
    pos4 = e.clientY;
    document.onmouseup = closeDragElement;
    document.onmousemove = elementDrag;
  }
  function elementDrag(e) {
    e.preventDefault();
    pos1 = pos3 - e.clientX;
    pos2 = pos4 - e.clientY;
    pos3 = e.clientX;
    pos4 = e.clientY;
    el.style.top = (el.offsetTop - pos2) + "px";
    el.style.left = (el.offsetLeft - pos1) + "px";
    el.style.bottom = "auto";
    el.style.right = "auto";
  }
  function closeDragElement() {
    document.onmouseup = null;
    document.onmousemove = null;
  }
}
</script>
{% endblock %}
